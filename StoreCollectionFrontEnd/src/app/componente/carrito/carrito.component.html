<div class="carrito-page">
  <!-- ==================== HEADER PREMIUM ==================== -->
  <div class="carrito-header">
    <div class="container">
      <div class="header-content">
        <div class="header-info">
          <h1 class="carrito-titulo">
            <i class="bi bi-cart4"></i> Mi Carrito
          </h1>
          <p class="carrito-resumen">
            <span class="items-count">{{ totalItems }} productos</span>
            <span class="total-separador">•</span>
            <span class="total-label">Total:</span>
            <span class="total-precio">S/ {{ totalPrecio | number:'1.2-2' }}</span>
          </p>
        </div>

        <div class="header-actions">
          <button class="btn-pagar-online" 
                  (click)="abrirFormularioCheckout()"
                  [disabled]="loading || items.length === 0 || isProcessingOnline">
            <i class="bi bi-credit-card-2-front-fill me-2"></i>
            Pagar Online
          </button>

          <button class="btn-whatsapp-header" 
                  (click)="checkoutWhatsapp()"
                  [disabled]="loading || items.length === 0 || isProcessingWhatsapp">
            <i class="bi bi-whatsapp me-2"></i>
            WhatsApp
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-5">
    <!-- ==================== ESTADOS ==================== -->
    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <h3>Cargando tu carrito...</h3>
    </div>

    <!-- Carrito vacío -->
    <div *ngIf="!loading && items.length === 0" class="empty-cart">
      <div class="empty-icon">
        <i class="bi bi-cart-x"></i>
      </div>
      <h2>Tu carrito está vacío</h2>
      <p>¡Explora nuestro catálogo y encuentra productos increíbles!</p>
      <a routerLink="/catalogo" class="btn-catalogo">
        <i class="bi bi-shop me-2"></i> Ir al catálogo
      </a>
    </div>

    <!-- Carrito con productos -->
    <div *ngIf="!loading && items.length > 0" class="carrito-main">
      <div class="row g-5">
        <!-- ==================== LISTA DE PRODUCTOS ==================== -->
        <div class="col-lg-8">
          <div class="productos-card">
            <div class="productos-header">
              <h4>
                <i class="bi bi-basket2-fill me-2"></i>
                Productos seleccionados ({{ totalItems }})
              </h4>
            </div>

            <div class="productos-list">
              @for (item of items; track item.id) {
                <div class="producto-card">
                  <div class="producto-imagen">
                    <img 
                      [src]="item.imagenUrl || 'https://via.placeholder.com/400x400?text=Producto'"
                      [alt]="item.nombreProducto"
                      class="img-fluid">
                  </div>

                  <div class="producto-info">
                    <div class="info-top">
                      <div class="info-left">
                        <h5 class="producto-nombre">{{ item.nombreProducto }}</h5>
                        <small class="sku">SKU: {{ item.sku || '—' }}</small>

                        @if (item.atributos?.length) {
                          <div class="atributos">
                            @for (attr of item.atributos; track attr.id) {
                              <span class="atributo-tag">
                                {{ attr.nombre }}: {{ attr.valor }}
                              </span>
                            }
                          </div>
                        }
                      </div>

                      <div class="info-right">
                        <div class="precio-unitario">
                          S/ {{ item.precio | number:'1.2-2' }} c/u
                        </div>
                        <div class="precio-total">
                          S/ {{ (item.precio * item.cantidad) | number:'1.2-2' }}
                        </div>
                      </div>
                    </div>

                    <div class="info-bottom">
                      <div class="cantidad-selector">
                        <button (click)="actualizarCantidad(item.id, -1)" 
                                [disabled]="item.cantidad <= 1">
                          <i class="bi bi-dash-lg"></i>
                        </button>
                        <span class="cantidad">{{ item.cantidad }}</span>
                        <button (click)="actualizarCantidad(item.id, 1)">
                          <i class="bi bi-plus-lg"></i>
                        </button>
                      </div>

                      <button class="btn-eliminar" (click)="eliminarItem(item.id)">
                        <i class="bi bi-trash"></i>
                        <span>Eliminar</span>
                      </button>
                    </div>
                  </div>
                </div>
              }

              <!-- Vaciar carrito -->
              <div class="productos-footer">
                <button class="btn-vaciar-carrito" (click)="vaciarCarrito()">
                  <i class="bi bi-trash me-2"></i>
                  Vaciar carrito
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== RESUMEN ==================== -->
        <div class="col-lg-4">
          <div class="resumen-card sticky-top" style="top: 100px;">
            <div class="resumen-header">
              <h4>
                <i class="bi bi-receipt me-2"></i> Resumen del pedido
              </h4>
            </div>

            <div class="resumen-body">
              <div class="resumen-linea">
                <span>Subtotal ({{ totalItems }} productos)</span>
                <span>S/ {{ totalPrecio | number:'1.2-2' }}</span>
              </div>

              <div class="resumen-total">
                <h3>Total a pagar</h3>
                <h2>S/ {{ totalPrecio | number:'1.2-2' }}</h2>
              </div>

              <div class="resumen-acciones">
                <button class="btn-pagar-resumen" 
                        (click)="abrirFormularioCheckout()"
                        [disabled]="isProcessingOnline">
                  <i class="bi bi-credit-card-2-front-fill me-2"></i>
                  Pagar Online
                </button>

                <button class="btn-whatsapp-resumen" 
                        (click)="checkoutWhatsapp()"
                        [disabled]="isProcessingWhatsapp">
                  <i class="bi bi-whatsapp me-2"></i>
                  WhatsApp
                </button>
              </div>

              <a routerLink="/catalogo" class="btn-continuar-comprando">
                <i class="bi bi-arrow-left-circle me-2"></i>
                Seguir comprando
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL CHECKOUT PREMIUM ==================== -->
  <div class="checkout-backdrop" 
       [class.show]="showCheckoutModal" 
       (click)="cerrarFormularioCheckout()">
    
    <div class="checkout-modal" 
         [class.show]="showCheckoutModal"
         (click)="$event.stopPropagation()">
      
      <button class="checkout-close" 
              (click)="cerrarFormularioCheckout()" 
              aria-label="Cerrar">
        <i class="bi bi-x-lg"></i>
      </button>

      <div class="checkout-content">
        <app-checkout-form 
          [tiendaId]="tiendaId"
          (onSubmit)="procesarCheckout($event)"
          (onCancel)="cerrarFormularioCheckout()">
        </app-checkout-form>
      </div>
    </div>
  </div>
</div>