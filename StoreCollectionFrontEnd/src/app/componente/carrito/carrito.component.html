<div class="carrito-page">
  <!-- ==================== HEADER PREMIUM ==================== -->
  <div class="carrito-header">
    <div class="container">
      <div class="header-content">
        <div class="header-info">
          <h1 class="carrito-titulo">
            <i class="bi bi-cart4"></i> Mi Carrito
          </h1>
          <p class="carrito-resumen">
            <span class="items-count">{{ totalItems }} productos</span>
            <span class="total-separador">•</span>
            <span class="total-label">Total:</span>
            <span class="total-precio">S/ {{ totalPrecio | number:'1.2-2' }}</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-4 py-lg-5">
    <!-- Loading -->
    <div *ngIf="loading" class="loading-container text-center py-5">
      <div class="spinner-border text-success" style="width: 5rem; height: 5rem;"></div>
      <h4 class="mt-4 text-dark">Cargando tu carrito...</h4>
    </div>

    <!-- Carrito vacío -->
    <div *ngIf="!loading && items.length === 0" class="empty-cart text-center py-5">
      <i class="bi bi-cart-x display-1 text-success opacity-50 mb-4"></i>
      <h2 class="mb-3">Tu carrito está vacío</h2>
      <p class="text-muted mb-4 lead">¡Explora nuestro catálogo y encuentra productos increíbles!</p>
      <a [routerLink]="['/', tienda?.slug, 'catalogo']" class="btn btn-success btn-lg px-5 py-3 rounded-pill shadow">
        <i class="bi bi-shop me-2"></i> Ir al Catálogo
      </a>
    </div>

    <!-- Carrito con productos -->
    <div *ngIf="!loading && items.length > 0" class="carrito-main">
      <div class="row g-4 g-xl-5">
        <!-- Lista de productos -->
        <div class="col-xl-8">
          <div class="productos-card">
            <div class="productos-header">
              <h4 class="mb-0">
                <i class="bi bi-basket2-fill me-2"></i>
                Productos seleccionados ({{ totalItems }})
              </h4>
            </div>

            <div class="productos-list">
              @for (item of items; track item.id) {
                <div class="producto-card">
                  <div class="producto-imagen">
                    <img 
                      [src]="item.imagenUrl || 'https://via.placeholder.com/300?text=Producto'"
                      [alt]="item.nombreProducto"
                      class="img-fluid rounded-3 shadow-sm">
                  </div>

                  <div class="producto-info">
                    <div class="info-top">
                      <div class="info-left">
                        <h5 class="producto-nombre">{{ item.nombreProducto }}</h5>
                        <small class="text-muted sku">SKU: {{ item.sku || '—' }}</small>

                        @if (item.atributos?.length) {
                          <div class="atributos mt-2">
                            @for (attr of item.atributos; track attr.id) {
                              <span class="atributo-tag">
                                {{ attr.nombre }}: {{ attr.valor }}
                              </span>
                            }
                          </div>
                        }
                      </div>

                      <div class="info-right text-end">
                        <div class="precio-unitario text-muted">
                          S/ {{ item.precio | number:'1.2-2' }} c/u
                        </div>
                        <div class="precio-total">
                          S/ {{ (item.precio * item.cantidad) | number:'1.2-2' }}
                        </div>
                      </div>
                    </div>

                    <div class="info-bottom">
                      <div class="cantidad-selector">
                        <button (click)="actualizarCantidad(item.id, -1)" 
                                [disabled]="item.cantidad <= 1">
                          <i class="bi bi-dash-lg"></i>
                        </button>
                        <span class="cantidad">{{ item.cantidad }}</span>
                        <button (click)="actualizarCantidad(item.id, 1)">
                          <i class="bi bi-plus-lg"></i>
                        </button>
                      </div>

                      <button class="btn-eliminar" (click)="eliminarItem(item.id)">
                        <i class="bi bi-trash me-1"></i>
                        Eliminar
                      </button>
                    </div>
                  </div>
                </div>
              }

              <div class="productos-footer">
                <button class="btn-vaciar-carrito" (click)="vaciarCarrito()">
                  <i class="bi bi-trash me-2"></i>
                  Vaciar carrito
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Resumen (sticky) -->
        <div class="col-xl-4">
          <div class="resumen-card sticky-top" style="top: 90px;">
            <div class="resumen-header">
              <h4 class="mb-0">
                <i class="bi bi-receipt me-2"></i> Resumen del pedido
              </h4>
            </div>

            <div class="resumen-body">
              <div class="resumen-linea">
                <span>Subtotal ({{ totalItems }} productos)</span>
                <span>S/ {{ totalPrecio | number:'1.2-2' }}</span>
              </div>

              <div class="resumen-total">
                <h3>Total a pagar</h3>
                <h2>S/ {{ totalPrecio | number:'1.2-2' }}</h2>
              </div>

              <div class="resumen-acciones">
                <button class="btn-whatsapp-resumen" 
                        (click)="enviarPedidoWhatsapp()"
                        [disabled]="isProcessingWhatsapp">
                  <i class="bi bi-whatsapp me-2"></i>
                  {{ isProcessingWhatsapp ? 'Preparando...' : 'Enviar pedido por WhatsApp' }}
                </button>
              </div>

              <a [routerLink]="['/', tienda?.slug, 'catalogo']" class="btn-continuar-comprando d-block text-center mt-4">
                <i class="bi bi-arrow-left-circle me-2"></i>
                Seguir comprando
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>