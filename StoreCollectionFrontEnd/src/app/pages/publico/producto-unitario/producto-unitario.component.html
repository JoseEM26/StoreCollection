<div class="container py-5" *ngIf="!loading && producto; else cargando">
  <button class="btn-volver" routerLink="/catalogo">Back Regresar</button>

  <div class="producto-grid">

    <!-- IMAGEN CON LUPA INTERNA (solo una imagen) -->
    <div class="imagen-seccion">
      <div class="zoom-container"
           (mousemove)="actualizarLupa($event)"
           (mouseenter)="mostrarLupa($event)"
           (mouseleave)="ocultarLupa()">

        <img [src]="imagenActual"
             [alt]="producto.nombre"
             class="imagen-principal"
             loading="lazy"
             (error)="imagenActual = fallbackImage">

        <!-- Lupa circular dentro de la imagen -->
        <div class="lupa-interna"
             [class.visible]="lupaVisible"
             [style.left.px]="lupaX"
             [style.top.px]="lupaY"
             [style.backgroundImage]="'url(' + imagenActual + ')'"
             [style.backgroundPosition.%]="(lupaX / 500 * 100)"
             [style.backgroundPositionY.%]="(lupaY / 500 * 100)">
        </div>

        <!-- Badge stock -->
        <div class="badge-stock" *ngIf="varianteSeleccionada">
          <span class="agotado" *ngIf="stockActual === 0">AGOTADO</span>
          <span class="ultimas" *ngIf="stockActual > 0 && stockActual <= 5">
            ¡Últimas {{ stockActual }}!
          </span>
        </div>
      </div>

      <!-- Miniaturas (opcional) -->
      <div class="miniaturas" *ngIf="producto.variantes.length > 1">
        <button *ngFor="let v of producto.variantes"
                class="mini-btn"
                [class.active]="v.imagenUrl === imagenActual"
                (click)="cambiarImagen(v.imagenUrl)"
                [disabled]="!v.imagenUrl">
          <img [src]="v.imagenUrl || fallbackImage" alt="variante">
        </button>
      </div>
    </div>

    <!-- INFO PRODUCTO -->
    <div class="info-seccion">
      <span class="categoria">{{ producto.nombreCategoria }}</span>
      <h1 class="titulo">{{ producto.nombre }}</h1>

      <div class="precio">
        S/ <span>{{ precioActual | number:'1.2-2' }}</span>
      </div>

      <!-- Variantes -->
      <div class="variantes" *ngIf="producto.variantes.length > 1">
        <h3>Elige tu variante</h3>
        <div class="lista-variantes">
          <button *ngFor="let v of producto.variantes"
                  class="variante-btn"
                  [class.selected]="v === varianteSeleccionada"
                  [class.agotado]="v.stock === 0"
                  [disabled]="v.stock === 0"
                  (click)="seleccionarVariante(v)">
            <div>S/ {{ v.precio | number:'1.2-2' }}</div>
            <small>{{ v.stock > 0 ? v.stock + ' disponibles' : 'Agotado' }}</small>
            <span class="check" *ngIf="v === varianteSeleccionada">Check</span>
          </button>
        </div>
      </div>

          <!-- Botones principales -->
      <div class="acciones">
        <!-- Mensaje de éxito -->
        <div class="alert alert-success text-center mb-4" *ngIf="mensajeExito">
          <i class="bi bi-check-circle me-2"></i>
          ¡{{ cantidad }} producto(s) agregado(s) al carrito!
        </div>

        <!-- Selector de cantidad + Agregar al carrito -->
        <div class="carrito-controls mb-4" *ngIf="hayStock">
          <div class="cantidad-selector">
            <button class="btn-cantidad" (click)="disminuirCantidad()" [disabled]="cantidad <= 1">
              <i class="bi bi-dash-lg"></i>
            </button>
            <span class="cantidad-numero">{{ cantidad }}</span>
            <button class="btn-cantidad" (click)="aumentarCantidad()" [disabled]="cantidad >= stockActual">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>

          <button class="btn-agregar-carrito"
                  (click)="agregarAlCarrito()"
                  [disabled]="agregandoAlCarrito">
            <span *ngIf="!agregandoAlCarrito">
              <i class="bi bi-cart-plus me-2"></i> Agregar al carrito
            </span>
            <span *ngIf="agregandoAlCarrito">
              <span class="spinner-border spinner-border-sm me-2"></span> Agregando...
            </span>
          </button>
        </div>

        <!-- WhatsApp principal -->
        <button class="btn-whatsapp" (click)="consultarWhatsApp()">
          <i class="bi bi-whatsapp me-2"></i> Consultar por WhatsApp
        </button>

        <div class="secundarios">
          <button class="btn-sec" (click)="llamarAhora()">
            <i class="bi bi-telephone me-2"></i> Llamar
          </button>
          <button class="btn-sec" (click)="abrirCotizacion()">
            <i class="bi bi-chat-dots me-2"></i> Cotizar
          </button>
        </div>
      </div>

      <!-- Garantías -->
      <div class="garantias">
        <div>Truck <strong>Envíos a todo el Perú</strong></div>
        <div>Shield <strong>Compra segura</strong></div>
        <div>Headset <strong>Atención 24/7</strong></div>
      </div>
    </div>
  </div>
</div>

<!-- Loading -->
<ng-template #cargando>
  <div class="loading">Cargando producto...</div>
</ng-template>

<!-- Modal -->
<div class="modal" *ngIf="showQuoteModal" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="cerrar" (click)="cerrarModal()">Close</button>
    <h3>Pide tu cotización</h3>
    <input [(ngModel)]="clienteNombre" placeholder="Nombre" required>
    <input [(ngModel)]="clienteTelefono" placeholder="WhatsApp" required>
    <textarea [(ngModel)]="clienteMensaje" placeholder="Mensaje (opcional)"></textarea>
    <button class="enviar" (click)="enviarCotizacion()" [disabled]="enviandoCotizacion">
      {{ enviandoCotizacion ? 'Enviando...' : 'Enviar por WhatsApp' }}
    </button>
  </div>
</div>