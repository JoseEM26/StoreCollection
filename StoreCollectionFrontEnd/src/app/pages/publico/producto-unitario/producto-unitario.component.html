<!-- src/app/componente/producto-unitario/producto-unitario.component.html -->

<div class="container py-5" *ngIf="!loading && producto; else cargando">
  <button class="btn-volver" routerLink="/catalogo">
    <i class="bi bi-arrow-left me-2"></i> Regresar al catálogo
  </button>

  <div class="producto-grid">
    <!-- ==================== IMAGEN PRINCIPAL ==================== -->
    <div class="imagen-seccion">
      <div class="imagen-container">
        <img
          [src]="imagenActual"
          [alt]="producto.nombre"
          class="imagen-principal"
          loading="lazy"
          (error)="imagenActual = fallbackImage"
        />

        <!-- Badges de stock -->
        <div class="badge-stock" *ngIf="varianteSeleccionada">
          <span class="agotado" *ngIf="stockActual === 0">AGOTADO</span>
          <span class="ultimas" *ngIf="stockActual > 0 && stockActual <= 5">
            ¡Últimas {{ stockActual }} unidades!
          </span>
        </div>
      </div>

      <!-- Miniaturas -->
      <div class="miniaturas" *ngIf="tieneVariantesConImagen">
        <button
          *ngFor="let v of producto.variantes"
          class="mini-btn"
          [class.active]="v.imagenUrl === imagenActual"
          (click)="cambiarImagen(v.imagenUrl)"
          [disabled]="!v.imagenUrl"
        >
          <img
            [src]="v.imagenUrl || fallbackImage"
            [alt]="'Variante ' + producto.nombre"
            loading="lazy"
          />
        </button>
      </div>
    </div>

    <!-- ==================== INFORMACIÓN DEL PRODUCTO ==================== -->
<div class="info-seccion bg-white rounded-4 border border-light-subtle px-4 px-md-5 py-5 py-md-6">

  <!-- Categoría + Título + Descripción corta -->
  <div class="mb-5">
    <span class="categoria-badge text-uppercase fw-semibold px-3 py-1 rounded-pill small text-white bg-gradient">
      {{ producto.nombreCategoria }}
    </span>

    <h1 class="titulo mt-4 mb-2 fw-extrabold text-dark">
      {{ producto.nombre }}
    </h1>

    <!-- Descripción corta - estilo limpio, sin cuadro, muy elegante -->
    <div class="descripcion-corta-wrapper mt-3 mb-5">
      <!-- Prioridad 1: descripción corta del producto (general) -->
      <p *ngIf="producto.descripcion_corta" 
         class="descripcion-corta text-secondary fst-italic mb-0 lead-sm">
        {{ producto.descripcion_corta }}
      </p>

      <!-- Prioridad 2: descripción de la variante (solo si no hay general) -->
      <p *ngIf="!producto.descripcion_corta && varianteSeleccionada?.descripcion_corta"
         class="descripcion-corta variante text-muted fst-italic mb-0 lead-sm opacity-85">
        {{ varianteSeleccionada?.descripcion_corta }}
      </p>
    </div>
  </div>

  <!-- Precio + Oferta -->
  <div class="precio-container mb-5 pb-4 border-bottom border-light">
    <div class="d-flex align-items-baseline flex-wrap gap-2 gap-md-3">
      <span class="fs-4 fw-bold text-dark">S/</span>
      <span class="precio-grande fw-black text-success">
        {{ precioActual | number:"1.2-2" }}
      </span>
    </div>

    <div class="precio-oferta mt-2 d-flex align-items-center flex-wrap gap-3" *ngIf="tienePrecioAnteriorMayor">
      <span class="precio-tachado text-muted fs-5 text-decoration-line-through">
        S/ {{ varianteSeleccionada?.precio_anterior | number:"1.2-2" }}
      </span>
      <span class="descuento-badge badge bg-danger-subtle text-danger fw-bold px-3 py-1 rounded-pill">
        -{{ calcularPorcentajeDescuento() }}%
      </span>
    </div>
  </div>

  <!-- Variante seleccionada (chips) -->
  <div class="variante-seleccionada mb-5" *ngIf="atributosTexto && varianteSeleccionada?.atributos?.length">
    <div class="d-flex align-items-center gap-2 mb-3">
      <span class="fw-semibold text-dark small">Variante seleccionada:</span>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <span class="atributo-chip px-3 py-1 rounded-pill bg-white border border-secondary-subtle small fw-medium shadow-xs"
            *ngFor="let attr of varianteSeleccionada?.atributos">
        {{ attr.atributoNombre }}: <strong class="text-dark">{{ attr.valor }}</strong>
      </span>
    </div>
  </div>

  <!-- Selección de opciones -->
  <div class="atributos-selector mb-5" *ngIf="atributosAgrupados.length > 0">
    <h3 class="h5 fw-bold mb-4 text-dark">Personaliza tu producto</h3>

    <div class="atributo-grupo mb-4" *ngFor="let grupo of atributosAgrupados">
      <label class="form-label fw-bold mb-3 d-block">{{ grupo.nombre }}</label>
      <div class="d-flex flex-wrap gap-2">
        <button type="button"
                class="opcion-btn btn rounded-pill px-4 py-2 fw-medium border-secondary-subtle"
                [class.btn-success]="seleccionAtributos[grupo.nombre] === valor"
                [class.disabled]="!esValorDisponible(grupo.nombre, valor)"
                (click)="seleccionarValorAtributo(grupo.nombre, valor)"
                *ngFor="let valor of grupo.valores">
          {{ valor }}
          <i class="bi bi-check-lg ms-2" *ngIf="seleccionAtributos[grupo.nombre] === valor"></i>
        </button>
      </div>
    </div>

    <!-- Estados -->
    <div class="alert-container mt-4">
      <div class="alert alert-light border-0 bg-light-subtle small py-2" *ngIf="!tieneAlgunaSeleccion()">
        <i class="bi bi-info-circle me-2"></i>Elige tus opciones para ver precio y stock
      </div>
      <div class="alert alert-warning border-0 bg-warning-subtle small py-2" *ngIf="tieneAlgunaSeleccion() && !varianteSeleccionada">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>Combinación no disponible
      </div>
      <div class="alert alert-danger border-0 bg-danger-subtle small py-2" *ngIf="varianteSeleccionada && stockActual === 0">
        <i class="bi bi-x-circle-fill me-2"></i>Esta variante está agotada
      </div>
    </div>

    <!-- Stock -->
    <div class="stock-info mt-4 p-3 bg-light rounded-3 border border-light" *ngIf="varianteSeleccionada">
      <div class="d-flex align-items-center gap-3">
        <i class="bi bi-box-seam fs-4"
           [ngClass]="{'text-success': stockActual > 5, 'text-warning': stockActual <= 5 && stockActual > 0, 'text-danger': stockActual === 0}"></i>
        <strong [ngClass]="{'text-success': stockActual > 5, 'text-warning': stockActual <= 5 && stockActual > 0, 'text-danger': stockActual === 0}">
          {{ stockActual === 0 ? 'Agotado' : stockActual + ' disponibles' }}
        </strong>
        <span class="badge bg-warning text-dark ms-2 small" *ngIf="stockActual > 0 && stockActual <= 5">
          ¡Últimas unidades!
        </span>
      </div>
    </div>
  </div>

  <!-- Acciones -->
  <div class="acciones mt-5 pt-5 border-top border-light">
    <div class="alert alert-success border-0 bg-success-subtle text-center mb-4 small py-2" *ngIf="mensajeExito">
      <i class="bi bi-check-circle-fill me-2"></i>
      ¡{{ cantidad }} producto(s) agregado(s)!
    </div>

    <div class="d-grid gap-3" *ngIf="varianteSeleccionada">
      <div class="d-flex flex-column flex-sm-row align-items-stretch gap-3">
        <div class="cantidad-selector input-group input-group-lg flex-grow-1 flex-sm-grow-0" style="max-width: 180px;">
          <button class="btn btn-outline-secondary" (click)="disminuirCantidad()" [disabled]="cantidad <= 1">
            <i class="bi bi-dash-lg"></i>
          </button>
          <span class="form-control text-center fw-bold">{{ cantidad }}</span>
          <button class="btn btn-outline-secondary" (click)="aumentarCantidad()"
                  [disabled]="cantidad >= stockActual || !hayStock">
            <i class="bi bi-plus-lg"></i>
          </button>
        </div>

        <button class="btn btn-success btn-lg flex-grow-1 d-flex align-items-center justify-content-center gap-2"
                (click)="agregarAlCarrito()"
                [disabled]="!hayStock || agregandoAlCarrito">
          <ng-container *ngIf="!agregandoAlCarrito">
            <i class="bi bi-cart-plus"></i> Agregar al carrito
          </ng-container>
          <ng-container *ngIf="agregandoAlCarrito">
            <span class="spinner-border spinner-border-sm"></span> Agregando...
          </ng-container>
        </button>
      </div>

      <button class="btn btn-outline-success btn-lg d-flex align-items-center justify-content-center gap-2"
              (click)="consultarWhatsApp()">
        <i class="bi bi-whatsapp"></i> Consultar por WhatsApp
      </button>
    </div>

    <div class="row g-2 mt-4">
      <div class="col-6">
        <button class="btn btn-outline-secondary w-100 py-2" (click)="llamarAhora()">
          <i class="bi bi-telephone me-1"></i> Llamar
        </button>
      </div>
      <div class="col-6">
        <button class="btn btn-outline-secondary w-100 py-2" (click)="abrirCotizacion()">
          <i class="bi bi-chat-dots me-1"></i> Cotizar
        </button>
      </div>
    </div>
  </div>

  <!-- Garantías -->
  <div class="garantias mt-5 pt-5 border-top border-light">
    <div class="row g-4 text-center">
      <div class="col-md-4">
        <i class="bi bi-truck fs-3 text-success mb-2 d-block"></i>
        <strong class="d-block small fw-medium">Envíos a todo el Perú</strong>
      </div>
      <div class="col-md-4">
        <i class="bi bi-shield-check fs-3 text-success mb-2 d-block"></i>
        <strong class="d-block small fw-medium">Compra 100% segura</strong>
      </div>
      <div class="col-md-4">
        <i class="bi bi-headset fs-3 text-success mb-2 d-block"></i>
        <strong class="d-block small fw-medium">Atención 24/7</strong>
      </div>
    </div>
  </div>

</div>
  </div>
</div>

<!-- LOADING -->
<ng-template #cargando>
  <div class="loading text-center py-5">
    <div
      class="spinner-border text-success"
      role="status"
      style="width: 4rem; height: 4rem"
    >
      <span class="visually-hidden">Cargando producto...</span>
    </div>
    <p class="mt-4 fs-4 text-muted">Cargando producto...</p>
  </div>
</ng-template>

<!-- MODAL COTIZACIÓN -->
<div class="modal" *ngIf="showQuoteModal" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="cerrar" (click)="cerrarModal()" aria-label="Cerrar">
      <i class="bi bi-x-lg"></i>
    </button>
    <h3>Pide tu cotización personalizada</h3>
    <p class="text-muted mb-4">Te contactaremos por WhatsApp en minutos</p>

    <form>
      <input
        type="text"
        [(ngModel)]="clienteNombre"
        placeholder="Tu nombre completo"
        class="form-control mb-3"
        required
      />

      <input
        type="tel"
        [(ngModel)]="clienteTelefono"
        placeholder="Tu número de WhatsApp"
        class="form-control mb-3"
        required
      />

      <textarea
        [(ngModel)]="clienteMensaje"
        placeholder="Mensaje adicional (opcional)"
        rows="4"
        class="form-control mb-4"
      ></textarea>

      <button
        type="button"
        class="btn-whatsapp w-100 py-3"
        (click)="enviarCotizacion()"
        [disabled]="enviandoCotizacion || !clienteNombre || !clienteTelefono"
      >
        <span *ngIf="!enviandoCotizacion">
          <i class="bi bi-send me-2"></i> Enviar por WhatsApp
        </span>
        <span *ngIf="enviandoCotizacion">
          <span class="spinner-border spinner-border-sm me-2"></span>
          Enviando...
        </span>
      </button>
    </form>
  </div>
</div>
