<!-- usuarios.component.html -->
<div class="usuarios-page">
  <div class="container">
    <!-- Header -->
    <div class="header mb-6">
      <h1 class="title">Gestión de Usuarios</h1>
      <p class="subtitle">Controla roles, permisos y estado de todos los usuarios</p>
    </div>

    <!-- Barra de acciones -->
    <div class="actions-bar">
      <div class="search-box">
        <i class="bi bi-search"></i>
        <input type="text" placeholder="Buscar usuario..." [(ngModel)]="busqueda" class="search-input">
      </div>

      <div class="filters">
        <select [(ngModel)]="filtroRol" class="filter-select">
          <option value="TODOS">Todos los roles</option>
          <option value="OWNER">Owner</option>
          <option value="ADMIN">Admin</option>
          <option value="CLIENTE">Cliente</option>
        </select>

        <button class="btn-primary" (click)="abrirModalCrear()">
          <i class="bi bi-plus-lg"></i>
          Nuevo Usuario
        </button>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Registrado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let u of usuariosFiltrados" class="user-row" [class.inactive]="!u.activo">
            <td class="user-cell">
              <div class="user-info">
                <div class="avatar">{{ u.nombre.charAt(0).toUpperCase() }}</div>
                <div>
                  <div class="user-name">{{ u.nombre }}</div>
                  <div class="user-id">ID: {{ u.id }}</div>
                </div>
              </div>
            </td>
            <td>
              <a href="mailto:{{u.email}}" class="email-link">{{ u.email }}</a>
            </td>
            <td>
              <span class="role-badge" [class]="'role-' + u.rol.toLowerCase()">{{ u.rol }}</span>
            </td>
            <td>
              <span class="status" [class.active]="u.activo">
                <i class="bi" [class.bi-check-circle-fill]="u.activo" [class.bi-x-circle-fill]="!u.activo"></i>
                {{ u.activo ? 'Activo' : 'Inactivo' }}
              </span>
            </td>
            <td class="date">{{ u.creadoEn | date:'dd MMM yyyy' }}</td>
            <td class="actions">
              <button class="action-btn edit" (click)="abrirModalEditar(u)" title="Editar">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="action-btn delete" (click)="eliminarUsuario(u)" title="Eliminar">
                <i class="bi bi-trash3"></i>
              </button>
              <button class="action-btn toggle" 
                      [class.active]="u.activo"
                      (click)="toggleEstado(u)"
                      [title]="u.activo ? 'Desactivar' : 'Activar'">
                <i class="bi" [class.bi-toggle-on]="u.activo" [class.bi-toggle-off]="!u.activo"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL (Crear / Editar) -->
<div *ngIf="modalAbierto" class="modal-overlay" (click)="cerrarModal()"></div>
<div *ngIf="modalAbierto" class="modal" role="dialog">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ esEdicion ? 'Editar Usuario' : 'Crear Nuevo Usuario' }}</h2>
      <button class="close-btn" (click)="cerrarModal()">×</button>
    </div>

    <form #userForm="ngForm" (ngSubmit)="guardarUsuario()" class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Nombre completo</label>
          <input type="text" [(ngModel)]="usuarioTemporal.nombre" name="nombre" required #nombre="ngModel"
                 [class.error]="nombre.invalid && nombre.touched">
          <small *ngIf="nombre.invalid && nombre.touched" class="error-text">Nombre obligatorio</small>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" [(ngModel)]="usuarioTemporal.email" name="email" required email #email="ngModel"
                 [class.error]="email.invalid && email.touched">
          <small *ngIf="email.invalid && email.touched" class="error-text">
            {{ email.errors?.['required'] ? 'Email obligatorio' : 'Email inválido' }}
          </small>
        </div>

        <div class="form-group">
          <label>Rol</label>
          <select [(ngModel)]="usuarioTemporal.rol" name="rol" required>
            <option value="CLIENTE">Cliente</option>
            <option value="ADMIN">Admin</option>
            <option value="OWNER">Owner</option>
          </select>
        </div>

        <div class="form-group">
          <label>Estado</label>
          <label class="switch">
            <input type="checkbox" [(ngModel)]="usuarioTemporal.activo" name="activo">
            <span class="slider"></span>
          </label>
          <span class="switch-label">{{ usuarioTemporal.activo ? 'Activo' : 'Inactivo' }}</span>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="cerrarModal()">Cancelar</button>
        <button type="submit" class="btn-primary" [disabled]="userForm.invalid">
          <i class="bi bi-check-lg"></i>
          {{ esEdicion ? 'Guardar Cambios' : 'Crear Usuario' }}
        </button>
      </div>
    </form>
  </div>
</div>