<div class="main-container" [class.loading-global]="loadingInicial">
  <!-- Loading Global -->
  <div class="global-loader" *ngIf="loadingInicial">
    <div class="spinner-border text-success" style="width: 4rem; height: 4rem;" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-4 fs-5 text-muted">Cargando productos disponibles...</p>
  </div>

  <div class="container py-4 py-md-5" *ngIf="!loadingInicial">
    <!-- Título -->
    <div class="text-center mb-5">
      <h1 class="display-5 fw-bold text-success d-flex align-items-center justify-content-center gap-3 flex-wrap">
        <i class="bi bi-cart-plus-fill fs-2"></i>
        Crear Venta Directa
      </h1>
      <p class="lead text-muted col-lg-8 mx-auto">Selecciona productos, elige variantes y confirma la venta al instante</p>
    </div>

    <div class="row g-4 g-xl-5">
      <!-- Lista de Productos -->
      <div class="col-lg-8 order-lg-1 order-2">
        <div class="card border-0 rounded-4 shadow-sm h-100">
          <div class="card-header bg-success text-white py-4 rounded-top-4">
            <h5 class="mb-0 fw-bold d-flex align-items-center">
              <i class="bi bi-search me-3 fs-4"></i>
              Buscar Productos
            </h5>
          </div>

          <div class="card-body p-4">
            <!-- Búsqueda -->
            <form [formGroup]="busquedaForm">
              <div class="input-group input-group-lg shadow-sm rounded-4 overflow-hidden mb-4">
                <span class="input-group-text bg-white border-0">
                  <i class="bi bi-search text-success"></i>
                </span>
                <input
                  type="text"
                  class="form-control border-0 fs-5"
                  placeholder="Buscar por nombre..."
                  formControlName="nombre"
                  autofocus>
              </div>
            </form>

            <!-- Grilla de productos -->
            <div class="productos-grid" (scroll)="onScroll($event)">
              <div class="row g-3 g-md-4">
                <!-- Skeleton Loading -->
                <div class="col-6 col-md-4 col-lg-4" *ngIf="loadingProductos && productos.length === 0">
                  <div class="producto-card skeleton" *ngFor="let _ of [].constructor(6)">
                    <div class="skeleton-img"></div>
                    <div class="p-3">
                      <div class="skeleton-text short"></div>
                      <div class="skeleton-text"></div>
                      <div class="skeleton-text mt-3 wide"></div>
                    </div>
                  </div>
                </div>

                <!-- Productos reales -->
                <div class="col-6 col-md-4 col-lg-4" *ngFor="let prod of productos">
                  <div
                    class="producto-card rounded-4 overflow-hidden shadow-sm border transition-all pointer"
                    [class.selected]="productoSeleccionado?.id === prod.id"
                    (click)="seleccionarProducto(prod)">
                    <div class="position-relative">
                      <img
                        [src]="prod.imagenPrincipal || 'assets/images/placeholder.jpg'"
                        class="card-img-top"
                        alt="{{ prod.nombre }}"
                        loading="lazy">
                      <div class="overlay-badge" *ngIf="prod.tieneVariantes">
                        <span class="badge bg-primary rounded-pill px-3 py-2 small">
                          {{ prod.cantidadVariantes }} variante{{ prod.cantidadVariantes > 1 ? 's' : '' }}
                        </span>
                      </div>
                    </div>
                    <div class="card-body p-3 p-md-4">
                      <h6 class="fw-bold mb-2 line-clamp-2">{{ prod.nombre }}</h6>
                      <p class="text-muted small mb-2">
                        Stock: <strong class="text-success">{{ prod.stockTotal }}</strong>
                      </p>
                      <p class="fw-bold text-success fs-5 mb-0">
                        S/ {{ prod.precioMinimo | number:'1.2-2' }}
                        <small class="text-muted fw-normal" *ngIf="prod.precioMaximo !== prod.precioMinimo">
                          - {{ prod.precioMaximo | number:'1.2-2' }}
                        </small>
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Loading más productos -->
              <div class="text-center py-5" *ngIf="loadingProductos && productos.length > 0">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Cargando más productos...</p>
              </div>

              <!-- Sin resultados -->
              <div class="text-center py-6" *ngIf="!loadingProductos && productos.length === 0">
                <i class="bi bi-search display-4 text-muted opacity-50 mb-4"></i>
                <h5 class="text-muted">No se encontraron productos</h5>
                <p class="text-muted">Intenta con otro término</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel derecho: Detalle + Carrito (fijo en móviles) -->
      <div class="col-lg-4 order-lg-2 order-1">
        <div class="sticky-top" style="top: 20px;">
          <!-- Detalle producto seleccionado -->
          <div class="card border-0 rounded-4 shadow-sm mb-4" *ngIf="productoSeleccionado">
           <div class="card-body p-4" *ngIf="productoSeleccionado">
  <h5 class="fw-bold text-success mb-4">
    <i class="bi bi-box-seam me-2"></i> Producto seleccionado
  </h5>

  <!-- Imagen grande del producto seleccionado -->
  <div class="text-center mb-4">
    <img 
      [src]="productoSeleccionado.imagenPrincipal || 'assets/images/placeholder.jpg'"
      class="img-fluid rounded-4 shadow-sm"
      style="max-height: 300px; object-fit: contain;"
      alt="{{ productoSeleccionado.nombre }}">
  </div>

  <h6 class="fw-bold fs-5 mb-4">{{ productoSeleccionado.nombre }}</h6>

  <!-- Variantes con loading sutil -->
  <div class="mb-4" *ngIf="productoSeleccionado.tieneVariantes">
    <label class="form-label fw-bold">Variante</label>
    
    <select 
      class="form-select form-select-lg rounded-4 shadow-sm"
      [(ngModel)]="varianteSeleccionada"
      [disabled]="loadingVariantes">
      <option [ngValue]="null">
        {{ loadingVariantes ? 'Cargando variantes...' : '— Seleccionar variante —' }}
      </option>
      <option *ngFor="let v of variantes" [ngValue]="v">
        {{ obtenerDescripcionVariante(v) }}
        <strong class="text-success"> • Stock: {{ v.stock }} • S/ {{ v.precio | number:'1.2-2' }}</strong>
      </option>
    </select>
  </div>

              <!-- Cantidad -->
              <div class="mb-4">
                <label class="form-label fw-bold">Cantidad</label>
                <input
                  type="number"
                  class="form-control form-control-lg text-center rounded-4 shadow-sm"
                  [(ngModel)]="cantidad"
                  min="1"
                  [max]="stockMaximo"
                  placeholder="1">
              </div>

              <button class="btn btn-success btn-lg w-100 rounded-4 shadow mb-3" (click)="agregarAlCarrito()">
                <i class="bi bi-cart-plus-fill me-2"></i>
                Agregar al Carrito
              </button>

              <small class="text-success d-block text-center">
                <i class="bi bi-info-circle me-1"></i>
                Puedes agregar más o seleccionar otro producto
              </small>
            </div>
          </div>

          <!-- Carrito -->
          <div class="card border-0 rounded-4 shadow-sm overflow-hidden" *ngIf="itemsVenta.length > 0">
            <div class="card-header bg-success text-white text-center py-4">
              <h5 class="mb-2 d-flex align-items-center justify-content-center gap-2">
                <i class="bi bi-cart4"></i>
                Carrito ({{ itemsVenta.length }})
              </h5>
              <h4 class="mb-0 fw-bold">Total: S/ {{ totalVenta | number:'1.2-2' }}</h4>
            </div>

            <div class="list-group list-group-flush">
              <div class="list-group-item py-3" *ngFor="let item of itemsVenta; let i = index">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1 me-3">
                    <div class="fw-semibold">{{ item.producto.nombre }}</div>
                    <small class="text-muted" *ngIf="item.variante">
                      {{ obtenerDescripcionVariante(item.variante) }}
                    </small>
                    <div class="mt-1">
                      <span class="badge bg-light text-dark">×{{ item.cantidad }}</span>
                      <strong class="text-success ms-2">S/ {{ item.subtotal | number:'1.2-2' }}</strong>
                    </div>
                  </div>
                  <button class="btn btn-outline-danger btn-sm rounded-circle" (click)="eliminarItem(i)">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="card-footer p-4">
              <button class="btn btn-primary btn-lg w-100 rounded-4 shadow-lg" (click)="confirmarVenta()">
                <i class="bi bi-check2-all me-2"></i>
                Confirmar Venta Directa
              </button>
            </div>
          </div>

          <!-- Carrito vacío -->
          <div class="text-center py-6 bg-light rounded-4" *ngIf="itemsVenta.length === 0 && !productoSeleccionado">
            <i class="bi bi-cart-x display-4 text-muted opacity-50 mb-4"></i>
            <h5 class="text-success">Carrito vacío</h5>
            <p class="text-muted">Selecciona un producto para comenzar</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón flotante para abrir carrito en móviles -->
  <button class="btn btn-success btn-lg rounded-circle shadow-lg position-fixed bottom-0 end-0 m-4 d-lg-none d-flex align-items-center justify-content-center"
          style="width: 60px; height: 60px; z-index: 1000;"
          (click)="scrollToCarrito()">
    <i class="bi bi-cart4 fs-4"></i>
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" *ngIf="itemsVenta.length > 0">
      {{ itemsVenta.length }}
    </span>
  </button>
</div>