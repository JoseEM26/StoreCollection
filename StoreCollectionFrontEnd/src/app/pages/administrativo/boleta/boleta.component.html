<div class="container py-5">
  <!-- Header Principal -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-5 gap-4">
    <div>
      <h1 class="display-6 mb-2 fw-bold text-primary">
        <i class="bi bi-receipt-cutoff me-3"></i>
        Gestión de Pedidos
      </h1>
      <p class="lead text-muted mb-0">Administra, procesa y coordina todos tus pedidos</p>
    </div>

    <div class="d-flex gap-3 align-items-center flex-wrap">
      <div class="input-group shadow-sm" style="width: 260px;">
        <span class="input-group-text bg-white border-0">
          <i class="bi bi-funnel-fill text-primary"></i>
        </span>
        <select class="form-select border-0 shadow-none fs-6" 
                [(ngModel)]="selectedEstado" 
                (ngModelChange)="filtrarPorEstado()">
          <option value="">Todos los estados</option>
          <option value="PENDIENTE">Pendientes</option>
          <option value="ATENDIDA">Atendidos</option>
          <option value="CANCELADA">Cancelados</option>
        </select>
      </div>

      <button class="btn btn-primary shadow px-5 py-2" (click)="cargarBoletas()">
        <i class="bi bi-arrow-clockwise me-2"></i>
        Actualizar
      </button>
    </div>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show rounded-4 shadow-sm" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>Error:</strong> {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = null"></button>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="text-center py-5 my-5">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <h4 class="mt-4 text-primary fw-semibold">Cargando pedidos...</h4>
  </div>

  <!-- Contenido principal -->
  <ng-container *ngIf="!isLoading">
    <!-- Sin pedidos -->
    <div *ngIf="boletas.length === 0" class="text-center py-5 bg-light rounded-4 shadow-sm">
      <i class="bi bi-inbox display-1 text-muted opacity-50 mb-4"></i>
      <h3 class="text-primary fw-semibold">No hay pedidos</h3>
      <p class="lead text-muted">Cuando lleguen nuevos pedidos, aparecerán aquí.</p>
    </div>

    <!-- Tabla de pedidos -->
    <div *ngIf="boletas.length > 0" class="card shadow-sm border-0 rounded-4 overflow-hidden">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="bg-primary text-white">
            <tr>
              <th class="ps-4 py-3 fw-semibold">Pedido</th>
              <th class="py-3 fw-semibold">Comprador</th>
              <th class="py-3 fw-semibold">Fecha</th>
              <th class="py-3 fw-semibold text-center">Items</th>
              <th class="py-3 fw-semibold text-end">Total</th>
              <th class="py-3 fw-semibold text-center">Estado</th>
              <th class="py-3 fw-semibold text-end pe-4">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let boleta of boletas" class="border-bottom">
              <td class="ps-4 py-4">
                <div class="fw-bold text-primary fs-5">#{{ boleta.id }}</div>
              </td>
              <td class="py-4">
                <div class="fw-semibold">{{ boleta.compradorNombre }}</div>
                <small class="text-muted d-block">{{ boleta.compradorEmail }}</small>
                <small class="text-muted" *ngIf="boleta.compradorTelefono">
                  <i class="bi bi-whatsapp me-1"></i> {{ boleta.compradorTelefono }}
                </small>
              </td>
              <td class="py-4 text-muted">
                {{ formatDate(boleta.fecha) }}
              </td>
              <td class="py-4 text-center">
                <span class="badge bg-light text-dark rounded-pill px-4 py-2">
                  {{ getTotalItems(boleta.detalles) }} ítem{{ getTotalItems(boleta.detalles) !== 1 ? 's' : '' }}
                </span>
              </td>
              <td class="py-4 text-end">
                <div class="fw-bolder text-primary fs-4">S/ {{ boleta.total | number:'1.2-2' }}</div>
              </td>
              <td class="py-4 text-center">
                <span class="badge rounded-pill px-4 py-3 fs-6 fw-bold"
                      [ngClass]="{
                        'bg-warning text-dark': boleta.estado === 'PENDIENTE',
                        'bg-success text-white': boleta.estado === 'ATENDIDA',
                        'bg-danger text-white': boleta.estado === 'CANCELADA'
                      }">
                  {{ boleta.estado === 'PENDIENTE' ? 'Pendiente' : 
                     boleta.estado === 'ATENDIDA' ? 'Atendido' : 'Cancelado' }}
                </span>
              </td>
              <td class="py-4 text-end pe-4">
                <div class="btn-group shadow-sm" role="group">
                  <!-- Ver detalle -->
                  <button class="btn btn-outline-secondary btn-sm" 
                          (click)="verDetalle(boleta)"
                          title="Ver detalle">
                    <i class="bi bi-eye"></i>
                  </button>

                  <!-- Enviar WhatsApp al cliente -->
                  <button class="btn btn-success btn-sm" 
                          (click)="enviarConfirmacionWhatsapp(boleta)"
                          title="Enviar confirmación al cliente">
                    <i class="bi bi-whatsapp"></i>
                  </button>

                  <!-- Descargar factura (solo si atendida) -->
                  <button class="btn btn-primary btn-sm"
                          *ngIf="boleta.estado === 'ATENDIDA'"
                          (click)="descargarFactura(boleta.id)"
                          title="Descargar factura">
                    <i class="bi bi-file-earmark-pdf"></i>
                  </button>

                  <!-- Volver a pendiente -->
                  <button class="btn btn-warning btn-sm text-white"
                          *ngIf="boleta.estado !== 'PENDIENTE'"
                          (click)="cambiarEstado(boleta, 'PENDIENTE')"
                          title="Volver a pendiente">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>

                  <!-- Atender -->
                  <button class="btn btn-success btn-sm"
                          *ngIf="boleta.estado === 'PENDIENTE'"
                          (click)="cambiarEstado(boleta, 'ATENDIDA')"
                          title="Marcar como atendido">
                    <i class="bi bi-check2-all"></i>
                  </button>

                  <!-- Cancelar -->
                  <button class="btn btn-danger btn-sm"
                          *ngIf="boleta.estado !== 'CANCELADA'"
                          (click)="cambiarEstado(boleta, 'CANCELADA')"
                          title="Cancelar pedido">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      <div class="card-footer bg-transparent border-top-0 py-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
          <div class="text-muted">
            Mostrando {{ boletas.length }} de {{ totalElements }} pedidos
            <span class="ms-2 text-primary small">(Página {{ currentPage + 1 }} de {{ totalPages }})</span>
          </div>

          <nav>
            <ul class="pagination pagination-primary mb-0">
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="cargarBoletas(0)" aria-label="Primera">«</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="paginaAnterior()" aria-label="Anterior">&lt;</button>
              </li>

              <li class="page-item" *ngFor="let p of visiblePages" 
                  [class.active]="p === currentPage">
                <button class="page-link" (click)="cargarBoletas(p)">{{ p + 1 }}</button>
              </li>

              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="paginaSiguiente()" aria-label="Siguiente">&gt;</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="cargarBoletas(totalPages - 1)" aria-label="Última">»</button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </ng-container>

<div class="modal fade" tabindex="-1"[class.show]="boletaSeleccionada"[style.display]="boletaSeleccionada ? 'block' : 'none'"(click)="cerrarDetalle()"><div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable"><div class="modal-content shadow-xl border-0 rounded-4" (click)="$event.stopPropagation()"><div class="modal-header bg-gradient bg-primary text-white rounded-top-4"><h4 class="modal-title fw-bold"><i class="bi bi-receipt me-3"></i>Detalle del Pedido #{{ boletaSeleccionada?.id }}</h4><button type="button" class="btn-close btn-close-white" (click)="cerrarDetalle()" aria-label="Cerrar"></button></div><div class="modal-body p-5" *ngIf="boletaSeleccionada"><!-- Información básica --><div class="row g-4 mb-5 pb-4 border-bottom"><div class="col-lg-4"><small class="text-muted text-uppercase fw-semibold">Fecha del pedido</small><div class="h5 fw-bold mt-1">{{ formatDate(boletaSeleccionada.fecha) }}</div></div><div class="col-lg-4"><small class="text-muted text-uppercase fw-semibold">Estado actual</small><br><span class="badge rounded-pill px-5 py-3 fs-5 mt-2"[ngClass]="getEstadoBadge(boletaSeleccionada.estado).class">{{ getEstadoBadge(boletaSeleccionada.estado).text }}</span></div><div class="col-lg-4 text-lg-end"><small class="text-muted text-uppercase fw-semibold">Total</small><div class="display-5 fw-bolder text-primary">S/ {{ boletaSeleccionada.total | number:'1.2-2' }}</div></div></div><!-- Datos del comprador --><div class="mb-5 pb-4 border-bottom"><h5 class="fw-bold mb-3 text-primary"><i class="bi bi-person-circle me-2"></i>Datos del Comprador</h5><div class="row g-4"><div class="col-md-6"><strong>Nombre:</strong> {{ boletaSeleccionada.compradorNombre }}</div><div class="col-md-6"><strong>Email:</strong> {{ boletaSeleccionada.compradorEmail }}</div><div class="col-md-6" *ngIf="boletaSeleccionada.compradorTelefono"><strong>Teléfono/WhatsApp:</strong> {{ boletaSeleccionada.compradorTelefono }}</div></div></div><!-- Dirección de envío --><div class="mb-5 pb-4 border-bottom"><h5 class="fw-bold mb-3 text-primary"><i class="bi bi-truck me-2"></i>Dirección de Envío</h5><div class="row g-4"><div class="col-12"><strong>Dirección:</strong> {{ boletaSeleccionada.direccionEnvio }}<span *ngIf="boletaSeleccionada.referenciaEnvio"> - {{ boletaSeleccionada.referenciaEnvio }}</span></div><div class="col-md-4"><strong>Distrito:</strong> {{ boletaSeleccionada.distrito }}</div><div class="col-md-4"><strong>Provincia:</strong> {{ boletaSeleccionada.provincia }}</div><div class="col-md-4"><strong>Departamento:</strong> {{ boletaSeleccionada.departamento }}</div><div class="col-md-4" *ngIf="boletaSeleccionada.codigoPostal"><strong>Código Postal:</strong> {{ boletaSeleccionada.codigoPostal }}</div><div class="col-12"><strong>Tipo de entrega:</strong><span class="badge bg-info text-white">{{ boletaSeleccionada.tipoEntrega === 'DOMICILIO' ? 'Envío a domicilio' :boletaSeleccionada.tipoEntrega === 'RECOGIDA_EN_TIENDA' ? 'Recojo en tienda' : 'Envío a agencia' }}</span></div></div></div><!-- Productos incluidos --><h5 class="fw-bold mb-4 text-primary border-bottom pb-3"><i class="bi bi-bag-check me-2"></i>Productos incluidos</h5><div class="list-group list-group-flush mb-5"><div *ngFor="let item of boletaSeleccionada.detalles"class="list-group-item px-4 py-4 border-start-0 border-end-0 border-top-0"><div class="row align-items-center"><div class="col-md-8"><div class="fw-bold fs-5">{{ item.nombreProducto }}</div><small class="text-muted"><i class="bi bi-upc-scan me-1"></i>SKU: {{ item.sku || 'Sin código' }}</small></div><div class="col-md-4 text-md-end mt-3 mt-md-0"><div class="badge bg-primary-subtle text-primary fs-5 px-4 py-2 mb-2">Cantidad: ×{{ item.cantidad }}</div><div class="h5 fw-bold text-primary mb-0">S/ {{ item.subtotal | number:'1.2-2' }}</div></div></div></div></div></div><div class="modal-footer border-0 bg-light rounded-bottom-4 py-4 justify-content-between"><button type="button" class="btn btn-outline-secondary btn-lg px-5" (click)="cerrarDetalle()"><i class="bi bi-x-circle me-2"></i>Cerrar</button><div class="d-flex gap-3"><button *ngIf="boletaSeleccionada?.estado === 'ATENDIDA'"class="btn btn-success btn-lg px-5 shadow"(click)="descargarFactura(boletaSeleccionada!.id)"><i class="bi bi-download me-2"></i>Descargar Factura PDF</button><button *ngIf="boletaSeleccionada?.estado !== 'PENDIENTE'"class="btn btn-warning btn-lg px-5"(click)="cambiarEstado(boletaSeleccionada!, 'PENDIENTE')"><i class="bi bi-arrow-counterclockwise me-2"></i>Volver a Pendiente</button><button *ngIf="boletaSeleccionada?.estado === 'PENDIENTE'"class="btn btn-success btn-lg px-5 shadow"(click)="cambiarEstado(boletaSeleccionada!, 'ATENDIDA')"><i class="bi bi-check2-all me-2"></i>Marcar como Atendido</button><button *ngIf="boletaSeleccionada?.estado !== 'CANCELADA'"class="btn btn-outline-danger btn-lg px-5"(click)="cambiarEstado(boletaSeleccionada!, 'CANCELADA')"><i class="bi bi-trash me-2"></i>Cancelar Pedido</button></div></div></div></div></div><!-- Backdrop --><div class="modal-backdrop fade"[class.show]="boletaSeleccionada"*ngIf="boletaSeleccionada"style="opacity: 0.7;"></div></div>