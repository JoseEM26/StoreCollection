<div class="container py-4 py-md-5">
  <!-- Header Principal -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3 gap-md-4">
    <div>
      <h1 class="display-6 mb-2 fw-bold text-primary">
        <i class="bi bi-receipt-cutoff me-3"></i>
        Gestión de Pedidos
      </h1>
      <p class="lead text-muted mb-0">Administra, procesa y coordina todos tus pedidos</p>
    </div>

    <div class="d-flex flex-wrap gap-2 w-100 w-md-auto">
      <!-- Filtro por estado -->
      <div class="input-group shadow-sm flex-fill flex-md-grow-0" style="min-width: 220px;">
        <span class="input-group-text bg-white border-0">
          <i class="bi bi-funnel-fill text-primary"></i>
        </span>
        <select class="form-select border-0 shadow-none fs-6" 
                [(ngModel)]="selectedEstado" 
                (ngModelChange)="filtrarPorEstado()">
          <option value="">Todos los estados</option>
          <option value="PENDIENTE">Pendientes</option>
          <option value="ATENDIDA">Atendidos</option>
          <option value="CANCELADA">Cancelados</option>
        </select>
      </div>

      <!-- Botones -->
      <button class="btn btn-outline-secondary shadow flex-fill flex-md-grow-0 px-4 py-2" (click)="cargarBoletas()">
        <i class="bi bi-arrow-clockwise me-2"></i>Actualizar
      </button>

      <button class="btn btn-success shadow flex-fill flex-md-grow-0 px-4 py-2" (click)="abrirModalVentaDirecta()">
        <i class="bi bi-cart-plus-fill me-2"></i>Crear Venta Directa
      </button>
    </div>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show rounded-4 shadow-sm" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>Error:</strong> {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = null"></button>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="text-center py-5 my-5">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <h4 class="mt-4 text-primary fw-semibold">Cargando pedidos...</h4>
  </div>

  <!-- Contenido principal -->
  <ng-container *ngIf="!isLoading">
    <!-- Sin pedidos -->
    <div *ngIf="boletas.length === 0" class="text-center py-5 bg-light rounded-4 shadow-sm">
      <i class="bi bi-inbox display-1 text-muted opacity-50 mb-4"></i>
      <h3 class="text-primary fw-semibold">No hay pedidos</h3>
      <p class="lead text-muted">Cuando lleguen nuevos pedidos, aparecerán aquí.</p>
    </div>

    <!-- Lista de pedidos -->
    <div *ngIf="boletas.length > 0">
      <!-- Vista de tabla para pantallas medianas y grandes -->
      <div class="card shadow-sm border-0 rounded-4 overflow-hidden elegant-card d-none d-lg-block">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle elegant-table">
            <thead class="bg-primary text-white">
              <tr>
                <th class="ps-4 py-3 fw-semibold">Pedido</th>
                <th class="py-3 fw-semibold">Comprador</th>
                <th class="py-3 fw-semibold">Fecha</th>
                <th class="py-3 fw-semibold text-center">Items</th>
                <th class="py-3 fw-semibold text-end">Total</th>
                <th class="py-3 fw-semibold text-center">Estado</th>
                <th class="py-3 fw-semibold text-end pe-4">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let boleta of boletas" class="border-bottom transition-row">
                <td class="ps-4 py-4">
                  <div class="fw-bold text-primary fs-5">#{{ boleta.id }}</div>
                </td>
                <td class="py-4">
                  <div class="fw-semibold">{{ boleta.compradorNombre }}</div>
                  <small class="text-muted d-block">{{ boleta.compradorEmail }}</small>
                  <small class="text-muted" *ngIf="boleta.compradorTelefono">
                    <i class="bi bi-whatsapp me-1 text-success"></i> {{ boleta.compradorTelefono }}
                  </small>
                </td>
                <td class="py-4 text-muted">{{ formatDate(boleta.fecha) }}</td>
                <td class="py-4 text-center">
                  <span class="badge bg-light text-dark rounded-pill px-4 py-2 elegant-badge">
                    {{ getTotalItems(boleta.detalles) }} ítem{{ getTotalItems(boleta.detalles) !== 1 ? 's' : '' }}
                  </span>
                </td>
                <td class="py-4 text-end">
                  <div class="fw-bolder text-primary fs-4">S/ {{ boleta.total | number:'1.2-2' }}</div>
                </td>
                <td class="py-4 text-center">
                  <span class="badge rounded-pill px-4 py-3 fs-6 fw-bold elegant-badge"
                        [ngClass]="{
                          'bg-warning text-dark': boleta.estado === 'PENDIENTE',
                          'bg-success text-white': boleta.estado === 'ATENDIDA',
                          'bg-danger text-white': boleta.estado === 'CANCELADA'
                        }">
                    {{ boleta.estado === 'PENDIENTE' ? 'Pendiente' : 
                       boleta.estado === 'ATENDIDA' ? 'Atendido' : 'Cancelado' }}
                  </span>
                </td>
                <td class="py-4 text-end pe-4">
                  <div class="btn-group elegant-btn-group shadow-sm" role="group">
                    <button class="btn btn-outline-secondary btn-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#detalleModal"
                            (click)="verDetalle(boleta)"
                            title="Ver detalle">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-success btn-sm" (click)="enviarConfirmacionWhatsapp(boleta)" title="Enviar WhatsApp">
                      <i class="bi bi-whatsapp"></i>
                    </button>
                    <button class="btn btn-primary btn-sm" *ngIf="boleta.estado === 'ATENDIDA'" (click)="descargarFactura(boleta.id)" title="Factura">
                      <i class="bi bi-file-earmark-pdf"></i>
                    </button>
                    <button class="btn btn-warning btn-sm text-white" *ngIf="boleta.estado !== 'PENDIENTE'" (click)="cambiarEstado(boleta, 'PENDIENTE')">
                      <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                    <button class="btn btn-success btn-sm" *ngIf="boleta.estado === 'PENDIENTE'" (click)="cambiarEstado(boleta, 'ATENDIDA')">
                      <i class="bi bi-check2-all"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" *ngIf="boleta.estado !== 'CANCELADA'" (click)="cambiarEstado(boleta, 'CANCELADA')">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Vista de tarjetas para móviles y tablets (d-lg-none) -->
      <div class="d-lg-none">
        <div class="card shadow-sm border-0 rounded-4 mb-3 elegant-card" *ngFor="let boleta of boletas">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <div class="fw-bold text-primary fs-4">#{{ boleta.id }}</div>
                <small class="text-muted">{{ formatDate(boleta.fecha) }}</small>
              </div>
              <span class="badge rounded-pill px-4 py-2 fs-6 fw-bold"
                    [ngClass]="{
                      'bg-warning text-dark': boleta.estado === 'PENDIENTE',
                      'bg-success text-white': boleta.estado === 'ATENDIDA',
                      'bg-danger text-white': boleta.estado === 'CANCELADA'
                    }">
                {{ boleta.estado === 'PENDIENTE' ? 'Pendiente' : 
                   boleta.estado === 'ATENDIDA' ? 'Atendido' : 'Cancelado' }}
              </span>
            </div>

            <div class="mb-3">
              <div class="fw-semibold">{{ boleta.compradorNombre }}</div>
              <small class="text-muted d-block">{{ boleta.compradorEmail }}</small>
              <small class="text-muted" *ngIf="boleta.compradorTelefono">
                <i class="bi bi-whatsapp me-1 text-success"></i> {{ boleta.compradorTelefono }}
              </small>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <span class="badge bg-light text-dark rounded-pill px-3 py-2">
                  {{ getTotalItems(boleta.detalles) }} ítem{{ getTotalItems(boleta.detalles) !== 1 ? 's' : '' }}
                </span>
              </div>
              <div class="fw-bolder text-primary fs-3">S/ {{ boleta.total | number:'1.2-2' }}</div>
            </div>

            <!-- Botones de acciones grandes y verticales en móvil -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button class="btn btn-outline-primary btn-lg" 
                      data-bs-toggle="modal" 
                      data-bs-target="#detalleModal"
                      (click)="verDetalle(boleta)">
                <i class="bi bi-eye me-2"></i> Ver detalle
              </button>
              <button class="btn btn-success btn-lg" (click)="enviarConfirmacionWhatsapp(boleta)">
                <i class="bi bi-whatsapp me-2"></i> WhatsApp
              </button>
              <button class="btn btn-primary btn-lg" *ngIf="boleta.estado === 'ATENDIDA'" (click)="descargarFactura(boleta.id)">
                <i class="bi bi-file-earmark-pdf me-2"></i> Factura
              </button>
              <button class="btn btn-warning btn-lg text-white" *ngIf="boleta.estado !== 'PENDIENTE'" (click)="cambiarEstado(boleta, 'PENDIENTE')">
                <i class="bi bi-arrow-counterclockwise me-2"></i> Reabrir
              </button>
              <button class="btn btn-success btn-lg" *ngIf="boleta.estado === 'PENDIENTE'" (click)="cambiarEstado(boleta, 'ATENDIDA')">
                <i class="bi bi-check2-all me-2"></i> Atender
              </button>
              <button class="btn btn-danger btn-lg" *ngIf="boleta.estado !== 'CANCELADA'" (click)="cambiarEstado(boleta, 'CANCELADA')">
                <i class="bi bi-x-lg me-2"></i> Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Paginación (siempre visible) -->
      <div class="card-footer bg-transparent border-top-0 py-4 mt-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
          <div class="text-muted">
            Mostrando {{ boletas.length }} de {{ totalElements }} pedidos
            <span class="ms-2 text-primary small">(Página {{ currentPage + 1 }} de {{ totalPages }})</span>
          </div>
          <nav>
            <ul class="pagination pagination-primary mb-0">
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="cargarBoletas(0)">«</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="paginaAnterior()">&lt;</button>
              </li>
              <li class="page-item" *ngFor="let p of visiblePages" [class.active]="p === currentPage">
                <button class="page-link" (click)="cargarBoletas(p)">{{ p + 1 }}</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="paginaSiguiente()">&gt;</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="cargarBoletas(totalPages - 1)">»</button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Los modales se mantienen igual (detalleModal y modal venta directa) -->
  <!-- ... (tu código de modales original queda intacto) ... -->

  <!-- MODAL DETALLE DE PEDIDO (Bootstrap estándar - FUNCIONA PERFECTO) -->
  <div class="modal fade" id="detalleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content shadow-xl border-0 rounded-4 elegant-modal">
        <div class="modal-header border-0 bg-primary text-white">
          <h5 class="modal-title fs-4">
            <i class="bi bi-receipt me-2"></i>
            Detalle del Pedido #{{ boletaSeleccionada?.id }}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4" *ngIf="boletaSeleccionada">
          <!-- Aquí puedes poner todo el detalle que quieras -->
          <div class="row g-4">
            <div class="col-md-6">
              <h6 class="text-primary fw-bold">Datos del Cliente</h6>
              <p><strong>Nombre:</strong> {{ boletaSeleccionada.compradorNombre }}</p>
              <p><strong>Email:</strong> {{ boletaSeleccionada.compradorEmail }}</p>
              <p><strong>Teléfono:</strong> {{ boletaSeleccionada.compradorTelefono || 'No proporcionado' }}</p>
            </div>
            <div class="col-md-6">
              <h6 class="text-primary fw-bold">Información de Entrega</h6>
              <p><strong>Tipo:</strong> {{ boletaSeleccionada.tipoEntrega || 'No especificado' }}</p>
              <p><strong>Dirección:</strong> {{ boletaSeleccionada.direccionEnvio || 'N/A' }}</p>
            </div>
          </div>
          <hr>
          <h6 class="text-primary fw-bold">Productos</h6>
          <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between" *ngFor="let item of boletaSeleccionada.detalles">
              <span>{{ item.nombreProducto }} × {{ item.cantidad }}</span>
              <span class="fw-bold">S/ {{ item.subtotal | number:'1.2-2' }}</span>
            </li>
          </ul>
          <div class="text-end mt-4">
            <h4 class="text-primary">Total: S/ {{ boletaSeleccionada.total | number:'1.2-2' }}</h4>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL CREAR VENTA DIRECTA (mejorado) -->
  <div class="modal fade" 
       [class.show]="mostrarModalVentaDirecta" 
       [style.display]="mostrarModalVentaDirecta ? 'block' : 'none'"
       tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 rounded-4 overflow-hidden shadow-lg">
        <div class="modal-header position-relative border-0 text-white py-4 px-5"
             style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);">
        
          <button type="button" class="btn-close btn-close-white opacity-100" 
                  (click)="cerrarModalVentaDirecta()" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body p-0 bg-white">
          <app-crear-venta-directa-form></app-crear-venta-directa-form>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop único para el modal de venta directa -->
  <div class="modal-backdrop fade show" 
       *ngIf="mostrarModalVentaDirecta"
       style="opacity: 0.7;"
       (click)="cerrarModalVentaDirecta()"></div>
</div>