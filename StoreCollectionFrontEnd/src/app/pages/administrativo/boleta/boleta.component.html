<div class="container py-5">
  <!-- Header Principal -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-5 gap-4">
    <div>
      <h1 class="display-6 mb-2 fw-bold text-primary">
        <i class="bi bi-receipt-cutoff me-3"></i>
        Gestión de Pedidos
      </h1>
      <p class="lead text-muted mb-0">Administra, procesa y coordina todos tus pedidos</p>
    </div>

    <div class="d-flex gap-3 align-items-center flex-wrap">
      <!-- Filtro por estado -->
      <div class="input-group shadow-sm" style="width: 260px;">
        <span class="input-group-text bg-white border-0">
          <i class="bi bi-funnel-fill text-primary"></i>
        </span>
        <select class="form-select border-0 shadow-none fs-6" 
                [(ngModel)]="selectedEstado" 
                (ngModelChange)="filtrarPorEstado()">
          <option value="">Todos los estados</option>
          <option value="PENDIENTE">Pendientes</option>
          <option value="ATENDIDA">Atendidos</option>
          <option value="CANCELADA">Cancelados</option>
        </select>
      </div>

      <!-- Botones -->
      <button class="btn btn-outline-secondary shadow px-4 py-2" (click)="cargarBoletas()">
        <i class="bi bi-arrow-clockwise me-2"></i>Actualizar
      </button>

      <button class="btn btn-success shadow px-5 py-2" (click)="abrirModalVentaDirecta()">
        <i class="bi bi-cart-plus-fill me-2"></i>Crear Venta Directa
      </button>
    </div>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show rounded-4 shadow-sm" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>Error:</strong> {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = null"></button>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="text-center py-5 my-5">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <h4 class="mt-4 text-primary fw-semibold">Cargando pedidos...</h4>
  </div>

  <!-- Contenido principal -->
  <ng-container *ngIf="!isLoading">
    <!-- Sin pedidos -->
    <div *ngIf="boletas.length === 0" class="text-center py-5 bg-light rounded-4 shadow-sm">
      <i class="bi bi-inbox display-1 text-muted opacity-50 mb-4"></i>
      <h3 class="text-primary fw-semibold">No hay pedidos</h3>
      <p class="lead text-muted">Cuando lleguen nuevos pedidos, aparecerán aquí.</p>
    </div>

    <!-- Tabla de pedidos -->
    <div *ngIf="boletas.length > 0" class="card shadow-sm border-0 rounded-4 overflow-hidden elegant-card">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle elegant-table">
          <thead class="bg-primary text-white">
            <tr>
              <th class="ps-4 py-3 fw-semibold">Pedido</th>
              <th class="py-3 fw-semibold">Comprador</th>
              <th class="py-3 fw-semibold">Fecha</th>
              <th class="py-3 fw-semibold text-center">Items</th>
              <th class="py-3 fw-semibold text-end">Total</th>
              <th class="py-3 fw-semibold text-center">Estado</th>
              <th class="py-3 fw-semibold text-end pe-4">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let boleta of boletas" class="border-bottom transition-row">
              <td class="ps-4 py-4">
                <div class="fw-bold text-primary fs-5">#{{ boleta.id }}</div>
              </td>
              <td class="py-4">
                <div class="fw-semibold">{{ boleta.compradorNombre }}</div>
                <small class="text-muted d-block">{{ boleta.compradorEmail }}</small>
                <small class="text-muted" *ngIf="boleta.compradorTelefono">
                  <i class="bi bi-whatsapp me-1 text-success"></i> {{ boleta.compradorTelefono }}
                </small>
              </td>
              <td class="py-4 text-muted">{{ formatDate(boleta.fecha) }}</td>
              <td class="py-4 text-center">
                <span class="badge bg-light text-dark rounded-pill px-4 py-2 elegant-badge">
                  {{ getTotalItems(boleta.detalles) }} ítem{{ getTotalItems(boleta.detalles) !== 1 ? 's' : '' }}
                </span>
              </td>
              <td class="py-4 text-end">
                <div class="fw-bolder text-primary fs-4">S/ {{ boleta.total | number:'1.2-2' }}</div>
              </td>
              <td class="py-4 text-center">
                <span class="badge rounded-pill px-4 py-3 fs-6 fw-bold elegant-badge"
                      [ngClass]="{
                        'bg-warning text-dark': boleta.estado === 'PENDIENTE',
                        'bg-success text-white': boleta.estado === 'ATENDIDA',
                        'bg-danger text-white': boleta.estado === 'CANCELADA'
                      }">
                  {{ boleta.estado === 'PENDIENTE' ? 'Pendiente' : 
                     boleta.estado === 'ATENDIDA' ? 'Atendido' : 'Cancelado' }}
                </span>
              </td>
              <td class="py-4 text-end pe-4">
                <div class="btn-group elegant-btn-group shadow-sm" role="group">
                  <button class="btn btn-outline-secondary btn-sm" 
                          data-bs-toggle="modal" 
                          data-bs-target="#detalleModal"
                          (click)="verDetalle(boleta)"
                          title="Ver detalle">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-success btn-sm" (click)="enviarConfirmacionWhatsapp(boleta)" title="Enviar WhatsApp">
                    <i class="bi bi-whatsapp"></i>
                  </button>
                  <button class="btn btn-primary btn-sm" *ngIf="boleta.estado === 'ATENDIDA'" (click)="descargarFactura(boleta.id)" title="Factura">
                    <i class="bi bi-file-earmark-pdf"></i>
                  </button>
                  <button class="btn btn-warning btn-sm text-white" *ngIf="boleta.estado !== 'PENDIENTE'" (click)="cambiarEstado(boleta, 'PENDIENTE')">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>
                  <button class="btn btn-success btn-sm" *ngIf="boleta.estado === 'PENDIENTE'" (click)="cambiarEstado(boleta, 'ATENDIDA')">
                    <i class="bi bi-check2-all"></i>
                  </button>
                  <button class="btn btn-danger btn-sm" *ngIf="boleta.estado !== 'CANCELADA'" (click)="cambiarEstado(boleta, 'CANCELADA')">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      <div class="card-footer bg-transparent border-top-0 py-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
          <div class="text-muted">
            Mostrando {{ boletas.length }} de {{ totalElements }} pedidos
            <span class="ms-2 text-primary small">(Página {{ currentPage + 1 }} de {{ totalPages }})</span>
          </div>
          <nav>
            <ul class="pagination pagination-primary mb-0">
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="cargarBoletas(0)">«</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="paginaAnterior()">&lt;</button>
              </li>
              <li class="page-item" *ngFor="let p of visiblePages" [class.active]="p === currentPage">
                <button class="page-link" (click)="cargarBoletas(p)">{{ p + 1 }}</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="paginaSiguiente()">&gt;</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="cargarBoletas(totalPages - 1)">»</button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- MODAL DETALLE DE PEDIDO - CORREGIDO Y ELEGANTE -->
  <div class="modal fade" id="detalleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content shadow-xl border-0 rounded-4 overflow-hidden elegant-modal">
        
        <!-- Header verde elegante -->
        <div class="modal-header text-white position-relative" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 2rem;">
          <div class="text-center w-100">
            <h4 class="modal-title fs-3 fw-bold mb-2">
              <i class="bi bi-receipt me-3"></i>
              Comprobante de Pedido
            </h4>
            <div class="fs-5 opacity-95">
              Pedido N° <strong class="fs-4">#{{ boletaSeleccionada?.id }}</strong>
              <span class="mx-3">•</span>
              <span>{{ boletaSeleccionada?.fecha | date:'dd MMMM yyyy - HH:mm' }}</span>
            </div>
          </div>
          <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body p-4 bg-light" *ngIf="boletaSeleccionada">
          
          <!-- Tarjeta de tienda (nombre fijo) -->
          <div class="row g-4 mb-4">
            <div class="col-md-6">
              <div class="bg-white rounded-4 shadow-sm p-4 border-start border-5 border-success">
                <h5 class="text-success fw-bold mb-3">
                  <i class="bi bi-shop me-2"></i> Tienda
                </h5>
                <div class="fs-4 fw-bold text-dark">Mi Tienda</div>
                <small class="text-muted">Venta directa / mostrador</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-white rounded-4 shadow-sm p-4 text-center">
                <h5 class="text-success fw-bold mb-3">
                  <i class="bi bi-tag-fill me-2"></i> Estado del Pedido
                </h5>
                <span class="badge rounded-pill px-5 py-3 fs-5 fw-bold"
                      [ngClass]="{
                        'bg-warning text-dark': boletaSeleccionada.estado === 'PENDIENTE',
                        'bg-success text-white': boletaSeleccionada.estado === 'ATENDIDA',
                        'bg-danger text-white': boletaSeleccionada.estado === 'CANCELADA'
                      }">
                  {{ boletaSeleccionada.estado === 'PENDIENTE' ? 'Pendiente' : 
                     boletaSeleccionada.estado === 'ATENDIDA' ? 'Atendido' : 'Cancelado' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Datos del comprador y entrega -->
          <h5 class="text-success fw-bold mb-3 border-bottom border-3 border-success pb-2">
            <i class="bi bi-person-badge me-2"></i> Datos del Comprador y Entrega
          </h5>
          <div class="bg-white rounded-4 shadow-sm p-4 mb-4">
            <div class="row g-4">
              <div class="col-lg-6">
                <h6 class="text-primary fw-bold mb-3">Datos del Comprador</h6>
                <table class="table table-borderless">
                  <tr><td class="fw-bold text-muted pe-3">Nombre:</td><td>{{ boletaSeleccionada.compradorNombre || '—' }}</td></tr>
                  <tr><td class="fw-bold text-muted pe-3">Correo:</td><td>{{ boletaSeleccionada.compradorEmail || '—' }}</td></tr>
                  <tr><td class="fw-bold text-muted pe-3">Teléfono:</td>
                    <td>
                      <i class="bi bi-whatsapp text-success me-1" *ngIf="boletaSeleccionada.compradorTelefono"></i>
                      {{ boletaSeleccionada.compradorTelefono || 'No proporcionado' }}
                    </td>
                  </tr>
                </table>
              </div>
              <div class="col-lg-6">
                <h6 class="text-primary fw-bold mb-3">Información de Entrega</h6>
                <table class="table table-borderless">
                  <tr>
                    <td class="fw-bold text-muted pe-3">Tipo:</td>
                    <td>
                      <span *ngIf="boletaSeleccionada.tipoEntrega === 'DOMICILIO'">Envío a domicilio</span>
                      <span *ngIf="boletaSeleccionada.tipoEntrega === 'RECOGIDA_EN_TIENDA'">Recojo en tienda</span>
                      <span *ngIf="boletaSeleccionada.tipoEntrega === 'AGENCIA'">Envío por agencia</span>
                      <span *ngIf="!boletaSeleccionada.tipoEntrega" class="text-muted">—</span>
                    </td>
                  </tr>
                  <tr><td class="fw-bold text-muted pe-3">Dirección:</td><td>{{ boletaSeleccionada.direccionEnvio || '—' }}</td></tr>
                  <tr>
                    <td class="fw-bold text-muted pe-3">Ubicación:</td>
                    <td>
                      {{ boletaSeleccionada.distrito || '—' }},
                      {{ boletaSeleccionada.provincia || '—' }},
                      {{ boletaSeleccionada.departamento || '—' }}
                      <span *ngIf="boletaSeleccionada.codigoPostal"> • CP: {{ boletaSeleccionada.codigoPostal }}</span>
                    </td>
                  </tr>
                  <tr *ngIf="boletaSeleccionada.referenciaEnvio">
                    <td class="fw-bold text-muted pe-3">Referencia:</td>
                    <td class="text-muted fst-italic">{{ boletaSeleccionada.referenciaEnvio }}</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>

          <!-- Detalle de productos -->
          <h5 class="text-success fw-bold mb-3 border-bottom border-3 border-success pb-2">
            <i class="bi bi-basket3 me-2"></i> Detalle de Productos
          </h5>
          <div class="bg-white rounded-4 shadow-sm overflow-hidden">
            <table class="table table-hover mb-0">
              <thead class="bg-success text-white">
                <tr>
                  <th class="ps-4 py-3">Producto</th>
                  <th class="text-center py-3">Cant.</th>
                  <th class="text-end py-3">Precio Unit.</th>
                  <th class="text-end pe-4 py-3">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of boletaSeleccionada.detalles">
                  <td class="ps-4 py-3">
                    <div class="fw-bold text-dark">{{ item.nombreProducto }}</div>
                    <small class="text-muted" *ngIf="item.sku">SKU: {{ item.sku }}</small>
                    <small class="text-muted d-block" *ngIf="item.atributos && item.atributos.length > 0">
                      <span *ngFor="let attr of item.atributos; let last = last">
                        {{ attr.nombre }}: {{ attr.valor }}{{ last ? '' : ' • ' }}
                      </span>
                    </small>
                  </td>
                  <td class="text-center py-3 fw-bold text-success">×{{ item.cantidad }}</td>
                  <td class="text-end py-3">S/ {{ item.precioUnitario | number:'1.2-2' }}</td>
                  <td class="text-end pe-4 py-3 fw-bold">S/ {{ item.subtotal | number:'1.2-2' }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Total destacado -->
          <div class="text-end mt-4">
            <div class="bg-success text-white d-inline-block rounded-4 px-5 py-4 shadow-lg">
              <div class="fs-5 fw-semibold opacity-90">TOTAL PAGADO</div>
              <div class="fs-1 fw-black lh-1">S/ {{ boletaSeleccionada.total | number:'1.2-2' }}</div>
            </div>
          </div>

          <!-- Footer -->
          <div class="text-center mt-5 pt-4 border-top">
            <p class="text-success fw-bold fs-5 mb-2">¡Gracias por tu compra!</p>
            <p class="text-muted">Esperamos verte pronto nuevamente en <strong class="text-success">Mi Tienda</strong></p>
          </div>
        </div>

        <div class="modal-footer border-0 justify-content-center py-4">
          <button type="button" class="btn btn-secondary btn-lg px-5" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i> Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL CREAR VENTA DIRECTA -->
  <div class="modal fade" 
       [class.show]="mostrarModalVentaDirecta" 
       [style.display]="mostrarModalVentaDirecta ? 'block' : 'none'"
       tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 rounded-4 overflow-hidden shadow-lg">
        <div class="modal-header position-relative border-0 text-white py-4 px-5"
             style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);">
          <h5 class="modal-title fs-4">
            <i class="bi bi-cart-plus-fill me-2"></i> Crear Venta Directa
          </h5>
          <button type="button" class="btn-close btn-close-white opacity-100" 
                  (click)="cerrarModalVentaDirecta()" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body p-0 bg-white">
          <app-crear-venta-directa-form></app-crear-venta-directa-form>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop para modal venta directa -->
  <div class="modal-backdrop fade show" 
       *ngIf="mostrarModalVentaDirecta"
       style="opacity: 0.7;"
       (click)="cerrarModalVentaDirecta()"></div>
</div>