<div class="product-form-container">
  <!-- Header -->
  <div class="form-header">
    <h2>
      {{ isEdit ? 'Editar Producto' : 'Crear Nuevo Producto' }}
      <small *ngIf="isEdit && producto?.id" class="text-muted ms-2">#{{ producto?.id }}</small>
    </h2>
    <button type="button" class="btn-close" (click)="cancel()" [disabled]="loading()" aria-label="Cerrar">
      ×
    </button>
  </div>

  <div class="form-body">
    <!-- Información General -->
    <section class="section">
      <h3 class="section-title">Información General</h3>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label required">Nombre del producto</label>
          <input
            type="text"
            [ngModel]="nombre()"
            (ngModelChange)="nombre.set($event); generarSlugDesdeNombre()"
            class="form-control"
            placeholder="Ej: Zapatillas Nike Air Max"
            autocomplete="off"
          />
          <small class="form-help">Se usará para mostrar en la tienda y generar el slug automáticamente.</small>
        </div>

        <div class="form-group">
          <label class="form-label required">Slug (URL amigable)</label>
          <input
            type="text"
            [ngModel]="slug()"
            (ngModelChange)="slug.set($event)"
            class="form-control"
            placeholder="Ej: zapatillas-nike-air-max"
          />
          <small class="form-help">Solo letras minúsculas, números y guiones.</small>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label required">Categoría</label>
          <select
            class="form-control"
            [ngModel]="categoriaId()"
            (ngModelChange)="categoriaId.set($event)"
          >
            <option value="" disabled>Seleccionar categoría</option>
            <option *ngFor="let c of categorias()" [value]="c.id">{{ c.descripcion }}</option>
          </select>
        </div>

        <div class="form-group" *ngIf="auth.isAdmin() && !isEdit">
          <label class="form-label required">Tienda</label>
          <select
            class="form-control"
            [ngModel]="tiendaId()"
            (ngModelChange)="tiendaId.set($event)"
          >
            <option value="" disabled>Seleccionar tienda</option>
            <option *ngFor="let t of tiendas()" [value]="t.id">{{ t.descripcion }}</option>
          </select>
        </div>

        <div class="form-group" *ngIf="!auth.isAdmin() && tiendaActual()">
          <label class="form-label">Tu tienda</label>
          <input
            type="text"
            [value]="tiendaActual()?.descripcion || ''"
            readonly
            class="form-control readonly"
          />
        </div>
      </div>

      <div class="form-group checkbox">
        <label class="form-check-label">
          <input
            type="checkbox"
            [ngModel]="activo()"
            (ngModelChange)="activo.set($event)"
            class="form-check-input"
          />
          <strong>Producto activo</strong> (visible en la tienda online)
        </label>
      </div>
    </section>

    <!-- Variantes -->
    <section class="section mt-5">
      <div class="d-flex justify-between align-center mb-4">
        <h3 class="section-title mb-0">Variantes ({{ variantes().length }})</h3>
        <button type="button" class="btn btn-success btn-sm" (click)="agregarVariante()">
          <i class="icon-plus">+</i> Agregar variante
        </button>
      </div>

      <div *ngIf="variantes().length === 0" class="empty-state">
        <p class="text-muted">Aún no has agregado variantes.</p>
        <button class="btn btn-primary" (click)="agregarVariante()">
          + Crear primera variante
        </button>
      </div>

      <div *ngFor="let item of variantesOrdenadas(); let i = index" class="variante-card mb-4">
        <div class="variante-header" (click)="toggleCollapse(i)">
          <div class="d-flex align-center">
            <span class="collapse-icon me-3">{{ collapsed()[i] ? '▶' : '▼' }}</span>
            <strong>Variante {{ i + 1 }}</strong>
            <span class="badge ms-3" [class.badge-new]="!item.variante.id"> {{ !item.variante.id ? 'Nueva' : 'Existente' }}</span>
            <span class="text-muted ms-3" *ngIf="item.variante.sku">SKU: {{ item.variante.sku }}</span>
          </div>
          <button type="button" class="btn btn-danger btn-sm" (click)="$event.stopPropagation(); eliminarVariante(i)">
            Eliminar
          </button>
        </div>

        <div [hidden]="collapsed()[i]" class="variante-body">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label required">SKU</label>
              <input [(ngModel)]="item.variante.sku" [name]="'sku_' + i" class="form-control" placeholder="Ej: ZAP-BL-42" />
            </div>
            <div class="form-group">
              <label class="form-label required">Precio</label>
              <input [(ngModel)]="item.variante.precio" [name]="'precio_' + i" type="number" min="0.01" step="0.01" class="form-control" />
            </div>
            <div class="form-group">
              <label class="form-label required">Stock</label>
              <input [(ngModel)]="item.variante.stock" [name]="'stock_' + i" type="number" min="0" class="form-control" />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Imagen de la variante</label>
            <div class="image-upload-container">
              <div class="image-preview-wrapper">
                <div *ngIf="imagenPreviews().get(i)" class="preview-container">
                  <img [src]="imagenPreviews().get(i)!" alt="Preview" class="preview-img">
                  <button type="button" class="btn-delete-img" (click)="eliminarImagen(i)" title="Eliminar imagen">×</button>
                </div>
                <div *ngIf="!imagenPreviews().get(i)" class="placeholder-img">
                  <span>Sin imagen</span>
                </div>
              </div>
              <input type="file" accept="image/*" (change)="onImagenChange($event, i)" class="file-input mt-3" />
              <small class="form-help d-block mt-2">Máximo 5 MB. Formatos: JPG, PNG, WebP.</small>
            </div>
          </div>

          <!-- Atributos -->
          <div class="mt-4">
            <div class="d-flex justify-between align-center mb-3">
              <h5 class="mb-0 fw-bold">Atributos ({{ item.variante.atributos.length }})</h5>
              <button type="button" class="btn btn-outline-primary btn-sm" (click)="agregarAtributo(i)">
                + Agregar atributo
              </button>
            </div>

            <div *ngIf="item.variante.atributos.length === 0" class="empty-atributos">
              No hay atributos definidos para esta variante.
            </div>

            <div class="atributos-list">
              <div class="atributo-row" *ngFor="let attr of item.variante.atributos; let j = index">
                <div class="attr-col">
                  <select
                    class="form-select"
                    [(ngModel)]="attr.atributoNombre"
                    (ngModelChange)="onAtributoChange(i, j, $event)"
                    [name]="'attrNom_' + i + '_' + j"
                  >
                    <option value="" disabled>Seleccionar atributo</option>
                    <option *ngIf="isAtributoPersonalizado(attr)" [value]="attr.atributoNombre">
                      {{ attr.atributoNombre }} (personalizado)
                    </option>
                    <option 
    *ngFor="let a of atributosDisponibles()" 
    [value]="a.descripcion"
    [disabled]="isAtributoYaUsado(i, a.descripcion, j)">
    {{ a.descripcion }}
  </option>
                    <option value="__new__" class="text-primary fw-bold">+ Crear nuevo atributo</option>
                  </select>

                  <input
                    *ngIf="attr.atributoNombre === '__new__'"
                    type="text"
                    [(ngModel)]="attr.atributoNombreTemp!"
                    placeholder="Ej: Talla, Material"
                    class="form-control mt-2 nuevo-input"
                    (blur)="finalizarNuevoAtributo(i, j)"
                    autofocus
                  />
                </div>

                <div class="attr-col" *ngIf="attr.atributoNombre && attr.atributoNombre !== '__new__'">
                  <select
                    class="form-select"
                    [(ngModel)]="attr.valor"
                    (ngModelChange)="onValorChange(i, j, $event)"
                    [name]="'attrVal_' + i + '_' + j"
                  >
                    <option value="" disabled>Seleccionar valor</option>
                    <option *ngIf="isValorPersonalizado(attr)" [value]="attr.valor">
                      {{ attr.valor }} (personalizado)
                    </option>
                    <option *ngFor="let v of getValoresForAtributo(attr.atributoNombre)" [value]="v.descripcion">
                      {{ v.descripcion }}
                    </option>
                    <!-- Opción para crear nuevo (siempre habilitada) -->
  <option value="__new__" class="text-primary fw-bold">
    + Crear nuevo atributo
  </option>
                  </select>

                  <input
                    *ngIf="attr.valor === '__new__'"
                    type="text"
                    [(ngModel)]="attr.valorTemp!"
                    placeholder="Ej: 42, Rojo, Algodón"
                    class="form-control mt-2 nuevo-input"
                    (blur)="finalizarNuevoValor(i, j)"
                    autofocus
                  />
                </div>

                <div class="attr-col action-col">
                  <button
                    type="button"
                    class="btn btn-danger btn-sm w-100"
                    (click)="eliminarAtributo(i, j)"
                  >
                    Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Acciones finales -->
    <div class="form-actions mt-5">
      <button type="button" class="btn btn-secondary me-3" (click)="cancel()" [disabled]="loading()">
        Cancelar
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="save()"
        [disabled]="loading() || variantes().length === 0"
      >
        <span *ngIf="loading()" class="spinner">Guardando...</span>
        <span *ngIf="!loading()">{{ isEdit ? 'Guardar cambios' : 'Crear producto' }}</span>
      </button>
    </div>
  </div>
</div>