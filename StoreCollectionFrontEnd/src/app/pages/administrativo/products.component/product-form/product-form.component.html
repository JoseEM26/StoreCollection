<div class="product-form-container">
  <!-- Título del modal/formulario -->
  <div class="form-header">
    <h2>
      {{ isEdit ? 'Editar Producto' : 'Crear Nuevo Producto' }}
      <small *ngIf="isEdit && producto?.id" class="text-muted">#{{ producto?.id }}</small>
    </h2>
    <button type="button" class="btn-close" (click)="cancel()" [disabled]="loading()" aria-label="Cerrar">×</button>
  </div>

  <div class="form-body">

    <!-- Información General -->
    <h3 class="section-title">Información General</h3>

    <div class="form-grid">
      <div class="form-group">
        <label><strong>Nombre del producto *</strong></label>
        <input type="text"
               [ngModel]="nombre()"
               (ngModelChange)="nombre.set($event); generarSlugDesdeNombre()"
               name="nombre"
               class="form-control"
               placeholder="Ej: Zapatillas Nike Air" />
      </div>

      <div class="form-group">
        <label><strong>Slug *</strong></label>
        <input type="text"
               [ngModel]="slug()"
               (ngModelChange)="slug.set($event)"
               name="slug"
               class="form-control"
               placeholder="Ej: zapatillas-nike-air" />
      </div>
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label><strong>Categoría *</strong></label>
        <select class="form-control"
                [ngModel]="categoriaId()"
                (ngModelChange)="categoriaId.set($event)"
                name="categoriaId">
          <option value="" disabled>Seleccionar categoría</option>
          <option *ngFor="let c of categorias()" [value]="c.id">{{ c.descripcion }}</option>
        </select>
      </div>

      <div class="form-group" *ngIf="auth.isAdmin()">
        <label><strong>Tienda *</strong></label>
        <select class="form-control"
                [ngModel]="tiendaId()"
                (ngModelChange)="tiendaId.set($event)"
                name="tiendaId">
          <option value="" disabled>Seleccionar tienda</option>
          <option *ngFor="let t of tiendas()" [value]="t.id">{{ t.descripcion }}</option>
        </select>
      </div>

      <div class="form-group" *ngIf="!auth.isAdmin() && tiendaActual()">
        <label><strong>Tienda</strong></label>
        <input type="text"
               [value]="tiendaActual()?.descripcion || ''"
               readonly
               class="form-control readonly" />
      </div>
    </div>

    <div class="form-group checkbox">
      <label>
        <input type="checkbox"
               [ngModel]="activo()"
               (ngModelChange)="activo.set($event)"
               name="activoProducto" />
        <strong>Producto activo (visible en la tienda)</strong>
      </label>
    </div>

    <!-- Variantes -->
    <h3 class="section-title mt-5">
      Variantes ({{ variantes().length }})
      <button type="button" class="btn-add" (click)="agregarVariante()">
        + Agregar variante
      </button>
    </h3>

    <div *ngIf="variantes().length === 0" class="empty-state">
      <p>No hay variantes aún.</p>
      <button class="btn-primary" (click)="agregarVariante()">+ Crear primera variante</button>
    </div>

    <div *ngFor="let item of variantesOrdenadas(); let i = index" class="variante-card">

      <div class="variante-header" (click)="toggleCollapse(i)">
        <span class="variante-title">
          Variante {{ i + 1 }} {{ !item.variante.id ? '(Nueva)' : '' }}
        </span>
        <span class="collapse-icon">{{ collapsed()[i] ? '▼' : '▲' }}</span>
      </div>

      <div [hidden]="collapsed()[i]" class="variante-body">

        <!-- Campos básicos -->
        <div class="form-grid">
          <div class="form-group">
            <label><strong>SKU *</strong></label>
            <input [(ngModel)]="item.variante.sku"
                   [name]="'sku_' + i"
                   class="form-control" />
          </div>
          <div class="form-group">
            <label><strong>Precio *</strong></label>
            <input [(ngModel)]="item.variante.precio"
                   [name]="'precio_' + i"
                   type="number"
                   class="form-control" />
          </div>
          <div class="form-group">
            <label><strong>Stock *</strong></label>
            <input [(ngModel)]="item.variante.stock"
                   [name]="'stock_' + i"
                   type="number"
                   class="form-control" />
          </div>
        </div>

        <!-- Imagen de la variante -->
        <div class="form-group">
          <label><strong>Imagen de la variante</strong></label>
          <div class="image-upload-container">

            <!-- Vista previa o placeholder -->
            <div class="image-preview-wrapper">
              <div *ngIf="imagenPreviews().get(i)" class="preview-container">
                <img [src]="imagenPreviews().get(i)!" alt="Preview variante" class="preview-img">
                <button type="button" class="btn-delete-img" (click)="eliminarImagen(i)">×</button>
              </div>

              <div *ngIf="!imagenPreviews().get(i)" class="placeholder-img">
                <span>Sin imagen</span>
              </div>
            </div>

            <!-- Input file -->
            <input type="file"
                   accept="image/*"
                   (change)="onImagenChange($event, i)"
                   class="file-input" />
          </div>
        </div>
<!-- Atributos -->
<h5 class="mt-4 mb-3 fw-bold">Atributos de la variante ({{ item.variante.atributos.length }})</h5>

<div class="mb-3">
  <button type="button" class="btn btn-primary btn-sm" (click)="agregarAtributo(i)">
    + Agregar atributo
  </button>
</div>

<div *ngIf="item.variante.atributos.length === 0" class="text-muted text-center py-4 bg-light rounded">
  No hay atributos definidos para esta variante.
</div>

<div class="row g-3" *ngFor="let attr of item.variante.atributos; let j = index">
  <!-- Columna: Nombre del atributo -->
  <div class="col-md-5">
    <select class="form-select form-select-sm"
            [(ngModel)]="attr.atributoNombre"
            (ngModelChange)="onAtributoChange(i, j, $event)"
            [name]="'attrNom_' + i + '_' + j">
      <option value="" disabled>Seleccionar atributo</option>
      
      <!-- ✅ Atributo personalizado (no existe en backend) -->
      <option *ngIf="isAtributoPersonalizado(attr)" [value]="attr.atributoNombre">
        {{ attr.atributoNombre }} (personalizado)
      </option>
      
      <!-- Atributos del backend -->
      <option *ngFor="let a of atributosDisponibles()" [value]="a.descripcion">
        {{ a.descripcion }}
      </option>
      
      <option value="__new__" class="fw-bold text-primary">+ Crear nuevo atributo</option>
    </select>

    <!-- Input para NUEVO atributo -->
    <input *ngIf="attr.atributoNombre === '__new__'"
           type="text"
           [(ngModel)]="attr.atributoNombreTemp!"
           [name]="'newAttr_' + i + '_' + j"
           placeholder="Nombre del nuevo atributo (ej: Talla)"
           class="form-control form-control-sm mt-2"
           (blur)="finalizarNuevoAtributo(i, j)"
           autofocus />
  </div>

  <!-- Columna: Valor -->
  <div class="col-md-5">
    <!-- Select de valores SOLO si hay atributo válido -->
    <div *ngIf="attr.atributoNombre && attr.atributoNombre !== '__new__'">
      <select class="form-select form-select-sm"
              [(ngModel)]="attr.valor"
              (ngModelChange)="onValorChange(i, j, $event)"
              [name]="'attrVal_' + i + '_' + j">
        <option value="" disabled>Seleccionar valor</option>
        
        <!-- ✅ Valor personalizado (no existe en valores del atributo) -->
        <option *ngIf="isValorPersonalizado(attr)" [value]="attr.valor">
          {{ attr.valor }} (personalizado)
        </option>
        
        <!-- Valores del backend para este atributo -->
        <option *ngFor="let v of getValoresForAtributo(attr.atributoNombre)" [value]="v.descripcion">
          {{ v.descripcion }}
        </option>
        
        <option value="__new__" class="fw-bold text-primary">+ Crear nuevo valor</option>
      </select>
    </div>

    <!-- Input para NUEVO valor -->
    <input *ngIf="attr.valor === '__new__'"
           type="text"
           [(ngModel)]="attr.valorTemp!"
           [name]="'newVal_' + i + '_' + j"
           placeholder="Escribe el valor (ej: 38, Rojo, M)"
           class="form-control form-control-sm mt-2"
           (blur)="finalizarNuevoValor(i, j)"
           autofocus />
  </div>

  <!-- Columna: Eliminar -->
  <div class="col-md-2 d-flex align-items-end">
    <button type="button"
            class="btn btn-danger btn-sm w-100"
            (click)="eliminarAtributo(i, j)">
      Eliminar
    </button>
  </div>
</div>

    <!-- Mensaje de error -->
    <div *ngIf="errorMessage()" class="alert-error">
      {{ errorMessage() }}
    </div>

    <!-- Botones finales -->
    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="cancel()" [disabled]="loading()">
        Cancelar
      </button>
      <button type="button"
              class="btn-primary"
              (click)="save()"
              [disabled]="loading() || variantes().length === 0">
        <span *ngIf="loading()">Guardando...</span>
        <span *ngIf="!loading()">{{ isEdit ? 'Guardar cambios' : 'Crear producto' }}</span>
      </button>
    </div>

  </div>
</div>