<div class="product-form-container">
  <!-- Título del modal/formulario -->
  <div class="form-header">
    <h2>
      {{ isEdit ? 'Editar Producto' : 'Crear Nuevo Producto' }}
      <small *ngIf="isEdit && producto?.id" class="text-muted">#{{ producto?.id }}</small>
    </h2>
    <button type="button" class="btn-close" (click)="cancel()" [disabled]="loading()" aria-label="Cerrar">×</button>
  </div>

  <div class="form-body">

    <!-- Información General -->
    <h3 class="section-title">Información General</h3>

    <div class="form-grid">
      <div class="form-group">
        <label><strong>Nombre del producto *</strong></label>
        <input type="text"
               [ngModel]="nombre()"
               (ngModelChange)="nombre.set($event); generarSlugDesdeNombre()"
               name="nombre"
               class="form-control"
               placeholder="Ej: Zapatillas Nike Air" />
      </div>

      <div class="form-group">
        <label><strong>Slug *</strong></label>
        <input type="text"
               [ngModel]="slug()"
               (ngModelChange)="slug.set($event)"
               name="slug"
               class="form-control"
               placeholder="Ej: zapatillas-nike-air" />
      </div>
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label><strong>Categoría *</strong></label>
        <select class="form-control"
                [ngModel]="categoriaId()"
                (ngModelChange)="categoriaId.set($event)"
                name="categoriaId">
          <option value="" disabled>Seleccionar categoría</option>
          <option *ngFor="let c of categorias()" [value]="c.id">{{ c.descripcion }}</option>
        </select>
      </div>

      <div class="form-group" *ngIf="auth.isAdmin()">
        <label><strong>Tienda *</strong></label>
        <select class="form-control"
                [ngModel]="tiendaId()"
                (ngModelChange)="tiendaId.set($event)"
                name="tiendaId">
          <option value="" disabled>Seleccionar tienda</option>
          <option *ngFor="let t of tiendas()" [value]="t.id">{{ t.descripcion }}</option>
        </select>
      </div>

      <div class="form-group" *ngIf="!auth.isAdmin() && tiendaActual()">
        <label><strong>Tienda</strong></label>
        <input type="text"
               [value]="tiendaActual()?.descripcion || ''"
               readonly
               class="form-control readonly" />
      </div>
    </div>

    <div class="form-group checkbox">
      <label>
        <input type="checkbox"
               [ngModel]="activo()"
               (ngModelChange)="activo.set($event)"
               name="activoProducto" />
        <strong>Producto activo (visible en la tienda)</strong>
      </label>
    </div>

    <!-- Variantes -->
    <h3 class="section-title mt-5">
      Variantes ({{ variantes().length }})
      <button type="button" class="btn-add" (click)="agregarVariante()">
        + Agregar variante
      </button>
    </h3>

    <div *ngIf="variantes().length === 0" class="empty-state">
      <p>No hay variantes aún.</p>
      <button class="btn-primary" (click)="agregarVariante()">+ Crear primera variante</button>
    </div>

    <div *ngFor="let item of variantesOrdenadas(); let i = index" class="variante-card">

      <div class="variante-header" (click)="toggleCollapse(i)">
        <span class="variante-title">
          Variante {{ i + 1 }} {{ !item.variante.id ? '(Nueva)' : '' }}
        </span>
        <span class="collapse-icon">{{ collapsed()[i] ? '▼' : '▲' }}</span>
      </div>

      <div [hidden]="collapsed()[i]" class="variante-body">

        <!-- Campos básicos -->
        <div class="form-grid">
          <div class="form-group">
            <label><strong>SKU *</strong></label>
            <input [(ngModel)]="item.variante.sku"
                   [name]="'sku_' + i"
                   class="form-control" />
          </div>
          <div class="form-group">
            <label><strong>Precio *</strong></label>
            <input [(ngModel)]="item.variante.precio"
                   [name]="'precio_' + i"
                   type="number"
                   class="form-control" />
          </div>
          <div class="form-group">
            <label><strong>Stock *</strong></label>
            <input [(ngModel)]="item.variante.stock"
                   [name]="'stock_' + i"
                   type="number"
                   class="form-control" />
          </div>
        </div>

        <!-- Imagen de la variante -->
        <div class="form-group">
          <label><strong>Imagen de la variante</strong></label>
          <div class="image-upload-container">

            <!-- Vista previa o placeholder -->
            <div class="image-preview-wrapper">
              <div *ngIf="imagenPreviews().get(i)" class="preview-container">
                <img [src]="imagenPreviews().get(i)!" alt="Preview variante" class="preview-img">
                <button type="button" class="btn-delete-img" (click)="eliminarImagen(i)">×</button>
              </div>

              <div *ngIf="!imagenPreviews().get(i)" class="placeholder-img">
                <span>Sin imagen</span>
              </div>
            </div>

            <!-- Input file -->
            <input type="file"
                   accept="image/*"
                   (change)="onImagenChange($event, i)"
                   class="file-input" />
          </div>
        </div>

        <!-- Atributos -->
        <h4 class="subsection-title">Atributos ({{ item.variante.atributos.length }})</h4>

        <button type="button" class="btn-add-small mb-3" (click)="agregarAtributo(i)">
          + Agregar atributo
        </button>

        <div *ngIf="item.variante.atributos.length === 0" class="text-muted italic">
          No hay atributos aún.
        </div>

        <div *ngFor="let attr of item.variante.atributos; let j = index" class="atributo-row">

          <div class="form-group attr-select">
            <select [(ngModel)]="attr.atributoNombre"
                    (ngModelChange)="onAtributoChange(i, j, $event)"
                    [name]="'attrNom_' + i + '_' + j"
                    class="form-control">
              <option value="" disabled>Seleccionar atributo</option>
              <option *ngFor="let a of atributosDisponibles()" [value]="a.descripcion">
                {{ a.descripcion }}
              </option>
              <option value="__new__">+ Nuevo atributo</option>
            </select>

            <input *ngIf="attr.atributoNombre === '__new__'"
                   [(ngModel)]="attr.atributoNombre"
                   [name]="'newAttr_' + i + '_' + j"
                   placeholder="Nombre del nuevo atributo"
                   class="form-control mt-2" />
          </div>

          <div class="form-group attr-select">
            <select *ngIf="attr.atributoNombre && attr.atributoNombre !== '__new__'"
                    [(ngModel)]="attr.valor"
                    (ngModelChange)="onValorChange(i, j, $event)"
                    [name]="'attrVal_' + i + '_' + j"
                    [disabled]="!attr.atributoNombre"
                    class="form-control">
              <option value="" disabled>Seleccionar valor</option>
              <option *ngFor="let v of getValoresForAtributo(attr.atributoNombre)" [value]="v.descripcion">
                {{ v.descripcion }}
              </option>
              <option value="__new__">+ Nuevo valor</option>
            </select>

            <input *ngIf="attr.atributoNombre === '__new__' || attr.valor === '__new__'"
                   [(ngModel)]="attr.valor"
                   [name]="'val_' + i + '_' + j"
                   placeholder="Valor del atributo"
                   class="form-control mt-2" />
          </div>

          <div class="delete-attr-btn">
            <button type="button" (click)="eliminarAtributo(i, j)" class="btn-delete-small">×</button>
          </div>
        </div>

      </div>
    </div>

    <!-- Mensaje de error -->
    <div *ngIf="errorMessage()" class="alert-error">
      {{ errorMessage() }}
    </div>

    <!-- Botones finales -->
    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="cancel()" [disabled]="loading()">
        Cancelar
      </button>
      <button type="button"
              class="btn-primary"
              (click)="save()"
              [disabled]="loading() || variantes().length === 0">
        <span *ngIf="loading()">Guardando...</span>
        <span *ngIf="!loading()">{{ isEdit ? 'Guardar cambios' : 'Crear producto' }}</span>
      </button>
    </div>

  </div>
</div>