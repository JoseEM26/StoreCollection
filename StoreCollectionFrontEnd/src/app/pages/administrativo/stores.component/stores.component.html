<div class="container-fluid py-5">
  <!-- Header -->
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-5 gap-4">
    <div>
      <h1 class="display-5 fw-bold text-primary mb-2">
        <i class="bi bi-shop-window me-3"></i>
        Gestión de Tiendas
      </h1>
      <p class="text-muted fs-5">
        {{ auth.isAdmin() ? 'Todas las tiendas de la plataforma' : 'Tus tiendas' }}
        <span class="badge bg-primary rounded-pill ms-2 fs-6">
          {{ tiendasPage()?.totalElements || 0 }}
        </span>
      </p>
    </div>
    <button
      class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm"
      (click)="openCreateModal()"
      *ngIf="auth.isLoggedIn() && !auth.isOwner() && !auth.isCustomer()"
    >
      <i class="bi bi-plus-circle-fill me-2"></i>
      Nueva Tienda
    </button>
  </div>

  <!-- Búsqueda -->
  <div class="row mb-5">
    <div class="col-lg-6 col-xl-5">
      <div class="input-group input-group-lg">
        <span class="input-group-text bg-transparent border-end-0">
          <i class="bi bi-search text-muted"></i>
        </span>
        <input
          type="text"
          class="form-control border-start-0 ps-0"
          placeholder="Buscar por nombre o slug..."
          [value]="searchInput()"
          (input)="searchInput.set($any($event).target.value)"
        />
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="text-center py-5">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-4 text-muted fs-4">Cargando tiendas...</p>
  </div>

  <!-- Grid de tiendas -->
  <div *ngIf="!loading() && tiendas().length > 0" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <div class="col" *ngFor="let tienda of tiendas()">
      <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden position-relative"
           [class.opacity-75]="!tienda.activo">

        <!-- Borde izquierdo según plan -->
        <div class="position-absolute top-0 start-0 bottom-0 border-start border-5"
             [class.border-primary]="tienda.planNombre === 'Básico'"
             [class.border-success]="tienda.planNombre === 'Gratis'"
             [class.border-warning]="tienda.planNombre === 'Pro'"
             [class.border-dark]="tienda.planNombre === 'Enterprise' || tienda.planNombre === 'Premium'"
             style="z-index: 1; width: 6px;"></div>

        <div class="card-body d-flex flex-column p-4 position-relative" style="z-index: 2;">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold"
                 style="width: 60px; height: 60px; font-size: 1.8rem;">
              {{ tienda.nombre.charAt(0).toUpperCase() }}
            </div>
            <span class="badge rounded-pill px-3 py-2 fs-6"
                  [class.bg-success]="tienda.activo"
                  [class.bg-danger]="!tienda.activo">
              {{ tienda.activo ? 'Activa' : 'Inactiva' }}
            </span>
          </div>

          <h5 class="card-title fw-bold mb-2">{{ tienda.nombre }}</h5>
          <p class="text-muted small mb-3">
            <i class="bi bi-globe me-1"></i>
            {{ tienda.slug }}.storecollection.com
          </p>

          <div class="text-muted small mb-4">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-whatsapp me-2"></i>
              {{ tienda.whatsapp || 'Sin WhatsApp' }}
            </div>
            <div class="d-flex align-items-center mb-3">
              <i class="bi bi-currency-exchange me-2"></i>
              {{ tienda.moneda }}
            </div>
          </div>

          <!-- Plan -->
          <div class="mt-auto mb-4">
            <span class="badge rounded-pill px-4 py-2 fs-6 fw-semibold text-white d-inline-flex align-items-center gap-2"
                  [class.bg-primary]="tienda.planNombre === 'Básico'"
                  [class.bg-success]="tienda.planNombre === 'Gratis'"
                  [class.bg-warning]="tienda.planNombre === 'Pro' || tienda.estadoSuscripcion === 'trial'"
                  [class.bg-dark]="tienda.planNombre === 'Enterprise' || tienda.planNombre === 'Premium'"
                  [class.bg-secondary]="!tienda.planNombre">
              <i class="bi bi-star-fill" *ngIf="tienda.planNombre === 'Pro' || tienda.planNombre === 'Premium' || tienda.planNombre === 'Enterprise'"></i>
              <i class="bi bi-gift-fill" *ngIf="tienda.estadoSuscripcion === 'trial'"></i>
              {{ tienda.planNombre || 'Sin plan' }}
            </span>

            <small class="text-muted d-block mt-2" *ngIf="tienda.estadoSuscripcion === 'trial'">
              <i class="bi bi-clock-history text-warning me-1"></i>
              Trial hasta {{ formatDate(tienda.trialEndsAt) }}
            </small>
            <small class="text-muted d-block mt-1" *ngIf="tienda.fechaFin && tienda.estadoSuscripcion !== 'trial'">
              <i class="bi bi-calendar-x me-1"></i>
              Expira: {{ formatDate(tienda.fechaFin) }}
            </small>
          </div>

          <!-- Límites -->
          <div class="border-top pt-3 small text-muted">
            <div class="row text-center">
              <div class="col">
                <strong class="d-block fs-5 text-primary">{{ tienda.maxProductos ?? 0 }}</strong>
                productos
              </div>
              <div class="col">
                <strong class="d-block fs-5 text-primary">{{ tienda.maxVariantes ?? 0 }}</strong>
                variantes
              </div>
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div class="card-footer bg-transparent border-0 pt-3 pb-4 px-4 position-relative" style="z-index: 3;">
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary flex-fill rounded-pill py-2" (click)="openEditModal(tienda)">
              <i class="bi bi-pencil me-1"></i> Editar
            </button>
            <button class="btn btn-info text-white flex-fill rounded-pill py-2" (click)="verDetalles(tienda)">
              <i class="bi bi-eye me-1"></i> Detalles
            </button>
            <button *ngIf="auth.isAdmin()"
                    class="btn rounded-circle p-3"
                    [class.btn-success]="tienda.activo"
                    [class.btn-danger]="!tienda.activo"
                    (click)="toggleActive(tienda)">
              <i class="bi fs-4" [class.bi-toggle-on]="tienda.activo" [class.bi-toggle-off]="!tienda.activo"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading() && tiendas().length === 0" class="text-center py-5 my-5">
    <i class="bi bi-shop display-1 text-muted opacity-25 mb-4"></i>
    <h3 class="fw-bold">No se encontraron tiendas</h3>
    <p class="lead text-muted" *ngIf="searchTerm().length > 0">
      No hay resultados para "{{ searchTerm() }}"
    </p>
    <p class="lead text-muted" *ngIf="searchTerm().length === 0">
      Aún no tienes tiendas creadas
    </p>
    <button class="btn btn-primary btn-lg rounded-pill px-5 mt-3" (click)="openCreateModal()">
      <i class="bi bi-plus-circle me-2"></i> Crear primera tienda
    </button>
  </div>

  <!-- Paginación -->
  <nav *ngIf="tiendasPage() && tiendasPage()!.totalPages > 1" class="d-flex justify-content-center mt-5">
    <ul class="pagination pagination-lg">
      <li class="page-item" [class.disabled]="currentPage() === 0">
        <button class="page-link rounded-pill px-4" (click)="goToPage(currentPage() - 1)" [disabled]="currentPage() === 0">
          <i class="bi bi-chevron-left"></i>
        </button>
      </li>
      <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage()">
        <button class="page-link rounded-pill" (click)="goToPage(page)">{{ page + 1 }}</button>
      </li>
      <li class="page-item" [class.disabled]="currentPage() === (tiendasPage()!.totalPages - 1)">
        <button class="page-link rounded-pill px-4" (click)="goToPage(currentPage() + 1)" [disabled]="currentPage() === (tiendasPage()!.totalPages - 1)">
          <i class="bi bi-chevron-right"></i>
        </button>
      </li>
    </ul>
  </nav>

  <!-- Modal Crear/Editar -->
  <div class="modal fade" [class.show]="showCreateModal || showEditModal" [class.d-block]="showCreateModal || showEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header border-0">
          <button type="button" class="btn-close" (click)="closeModal()" [disabled]="loading()"></button>
        </div>
        <div class="modal-body p-0">
          <app-form-stores
            [tienda]="editingStore()"
            (success)="onFormSuccess($event)"
            (cancel)="closeModal()"
          ></app-form-stores>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detalles -->
  <div class="modal fade" [class.show]="showDetailsModal" [class.d-block]="showDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">
            <i class="bi bi-info-circle text-primary me-2"></i>
            Detalles: {{ selectedTienda?.nombre }}
          </h5>
          <button type="button" class="btn-close" (click)="closeDetailsModal()"></button>
        </div>
        <div class="modal-body" *ngIf="selectedTienda">
          <div class="row g-4">
            <div class="col-md-6">
              <strong>Nombre:</strong> {{ selectedTienda.nombre }}<br>
              <strong>Slug:</strong> {{ selectedTienda.slug }}.storecollection.com<br>
              <strong>Dueño:</strong> {{ selectedTienda.userEmail }}<br>
              <strong>Estado:</strong>
              <span class="badge ms-2" [class.bg-success]="selectedTienda.activo" [class.bg-danger]="!selectedTienda.activo">
                {{ selectedTienda.activo ? 'Activa' : 'Inactiva' }}
              </span>
            </div>
            <div class="col-md-6">
              <strong>WhatsApp:</strong> {{ selectedTienda.whatsapp || 'No definido' }}<br>
              <strong>Moneda:</strong> {{ selectedTienda.moneda }}<br>
              <strong>Descripción:</strong> {{ selectedTienda.descripcion || 'Sin descripción' }}
            </div>
          </div>

          <hr class="my-4">

          <h6 class="fw-bold text-primary mb-3">
            <i class="bi bi-credit-card-2-back me-2"></i>
            Plan activo
          </h6>
          <div class="bg-light rounded-4 p-4">
            <div class="row mb-3">
              <div class="col-sm-6">
                <strong>Plan:</strong> {{ selectedTienda.planNombre || 'Sin plan activo' }}<br>
                <strong>Estado:</strong>
                <span class="badge ms-2"
                      [class.bg-warning]="selectedTienda.estadoSuscripcion === 'trial'"
                      [class.bg-success]="selectedTienda.estadoSuscripcion === 'active'"
                      [class.bg-secondary]="!selectedTienda.estadoSuscripcion">
                  {{ getEstadoSuscripcion(selectedTienda) }}
                </span>
              </div>
              <div class="col-sm-6">
                <div *ngIf="selectedTienda.trialEndsAt">
                  <strong>Fin del trial:</strong> {{ formatDate(selectedTienda.trialEndsAt) }}<br>
                </div>
                <div *ngIf="selectedTienda.fechaFin && selectedTienda.estadoSuscripcion !== 'trial'">
                  <strong>Expira:</strong> {{ formatDate(selectedTienda.fechaFin) }}
                </div>
              </div>
            </div>
            <hr class="my-3">
            <div class="row text-center">
              <div class="col-6">
                <h4 class="fw-bold text-primary">{{ selectedTienda.maxProductos ?? 0 }}</h4>
                <small class="text-muted">Productos permitidos</small>
              </div>
              <div class="col-6">
                <h4 class="fw-bold text-primary">{{ selectedTienda.maxVariantes ?? 0 }}</h4>
                <small class="text-muted">Variantes permitidas</small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary rounded-pill px-4" (click)="closeDetailsModal()">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop -->
  <div class="modal-backdrop fade show" *ngIf="showCreateModal || showEditModal || showDetailsModal"></div>
</div>