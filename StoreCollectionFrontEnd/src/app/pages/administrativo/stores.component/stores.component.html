<div class="container-fluid py-5 stores-container">
  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-5 gap-4">
    <div>
      <h1 class="display-5 fw-bold mb-1 page-title">
        <i class="bi bi-shop-window me-3 text-primary"></i>
        Gestión de Tiendas
      </h1>
      <p class="text-muted fs-5 mb-0 d-flex align-items-center">
        {{ auth.isAdmin() ? 'Todas las tiendas de la plataforma' : 'Tus tiendas activas' }}
        <span class="badge bg-gradient-primary rounded-pill ms-3 px-4 py-2 fs-6 fw-semibold shadow-sm">
          {{ tiendasPage()?.totalElements || 0 }}
        </span>
      </p>
    </div>

    <button class="btn btn-primary btn-lg rounded-pill px-5 py-3 shadow-lg btn-create" (click)="openCreateModal()">
      <i class="bi bi-plus-circle-fill me-2 fs-4"></i>
      Nueva Tienda
    </button>
  </div>

  <!-- Búsqueda -->
  <div class="row justify-content-center mb-5">
    <div class="col-lg-7 col-xl-6">
      <div class="input-group input-group-lg shadow-sm">
        <span class="input-group-text bg-white border-end-0 rounded-start-pill ps-4">
          <i class="bi bi-search text-primary"></i>
        </span>
        <input
          type="text"
          class="form-control rounded-end-pill pe-4 border-start-0 search-input"
          placeholder="Buscar por nombre, slug o dueño..."
          [value]="searchInput()"
          (input)="searchInput.set($any($event.target).value)"
        />
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="text-center py-5 my-5">
    <div class="spinner-grow text-primary" style="width: 5rem; height: 5rem;" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <h4 class="mt-4 fw-bold text-primary">Cargando tiendas...</h4>
    <p class="text-muted mt-2">Un momento por favor</p>
  </div>

  <ng-container *ngIf="!loading()">
    <!-- Estado vacío -->
    <div *ngIf="tiendas().length === 0" class="text-center py-5 my-5">
      <i class="bi bi-shop-window display-1 text-muted opacity-50 mb-4"></i>
      <h3 class="fw-bold text-dark mb-3">No hay tiendas aún</h3>

      <p class="lead text-muted mb-4" *ngIf="searchTerm().length > 0">
        No encontramos resultados para "<strong>{{ searchTerm() }}</strong>"
      </p>
      <p class="lead text-muted mb-4" *ngIf="searchTerm().length === 0">
        Crea tu primera tienda para empezar a vender
      </p>

      <button class="btn btn-primary btn-lg rounded-pill px-5 py-3 shadow" (click)="openCreateModal()">
        <i class="bi bi-plus-circle me-2"></i> Crear mi primera tienda
      </button>
    </div>

    <!-- Grid de tiendas -->
    <div *ngIf="tiendas().length > 0" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <div class="col" *ngFor="let tienda of tiendas()">
        <div class="card h-100 border-0 shadow-lg rounded-4 overflow-hidden hover-lift store-card">
          <div class="card-body d-flex flex-column p-4">
            <div class="d-flex justify-content-between align-items-start mb-4">
              <div class="d-flex align-items-center gap-3">
                <div class="avatar-circle text-white d-flex align-items-center justify-content-center fw-bold fs-4">
                  {{ tienda.nombre.charAt(0).toUpperCase() }}
                </div>
                <div>
                  <h5 class="card-title fw-bold mb-1">{{ tienda.nombre }}</h5>
                  <small class="text-muted">/{{ tienda.slug }}</small>
                </div>
              </div>

              <span class="badge rounded-pill px-4 py-2 fs-6 fw-semibold"
                    [ngClass]="tienda.activo ? 'bg-success' : 'bg-danger'">
                {{ tienda.activo ? 'Activa' : 'Inactiva' }}
              </span>
            </div>

            <!-- Plan -->
            <div class="mb-4">
              <span class="badge rounded-pill px-4 py-2 fs-6 fw-bold text-white"
                    [ngClass]="getPlanBadgeClass(tienda)">
                {{ tienda.planNombre || 'Sin plan' }}
                <small *ngIf="tienda.estadoSuscripcion === 'trial'" class="ms-2">(Prueba)</small>
              </span>
            </div>

            <!-- Info básica -->
            <div class="text-muted small mb-4">
              <div class="d-flex align-items-center mb-3">
                <i class="bi bi-whatsapp me-2 text-success fs-5"></i>
                {{ tienda.whatsapp || 'Sin WhatsApp' }}
              </div>
              <div class="d-flex align-items-center mb-3">
                <i class="bi bi-currency-exchange me-2 text-primary fs-5"></i>
                {{ tienda.moneda }}
              </div>
            </div>

            <!-- Límites -->
            <div class="mt-auto pt-4 border-top">
              <div class="row text-center small fw-semibold">
                <div class="col">
                  <div class="fs-4 fw-bold text-primary">{{ tienda.maxProductos ?? 0 }}</div>
                  <div class="text-muted">Productos</div>
                </div>
                <div class="col">
                  <div class="fs-4 fw-bold text-primary">{{ tienda.maxVariantes ?? 0 }}</div>
                  <div class="text-muted">Variantes</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="card-footer bg-transparent border-0 px-4 pb-4 pt-0">
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-outline-primary flex-fill rounded-pill py-3" (click)="openEditModal(tienda)">
                <i class="bi bi-pencil-square me-2"></i> Editar
              </button>
              <button class="btn btn-outline-info flex-fill rounded-pill py-3" (click)="verDetalles(tienda)">
                <i class="bi bi-eye me-2"></i> Detalles
              </button>
              <button *ngIf="auth.isAdmin()"
                      class="btn btn-success flex-fill rounded-pill py-3"
                      (click)="renovarTienda(tienda)">
                <i class="bi bi-arrow-repeat me-2"></i> Renovar
              </button>
              <button *ngIf="auth.isAdmin()"
                      class="btn rounded-circle shadow-sm p-3"
                      [ngClass]="tienda.activo ? 'btn-success' : 'btn-danger'"
                      (click)="toggleActive(tienda)">
                <i class="bi fs-4" [ngClass]="tienda.activo ? 'bi-toggle-on' : 'bi-toggle-off'"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginación -->
    <nav *ngIf="tiendasPage() && tiendasPage()!.totalPages > 1" class="d-flex justify-content-center mt-5">
      <ul class="pagination pagination-lg shadow-sm">
        <li class="page-item" [class.disabled]="currentPage() === 0">
          <button class="page-link rounded-circle" (click)="goToPage(currentPage() - 1)">
            <i class="bi bi-chevron-left"></i>
          </button>
        </li>

        <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage()">
          <button class="page-link rounded-circle mx-1" (click)="goToPage(page)">
            {{ page + 1 }}
          </button>
        </li>

        <li class="page-item" [class.disabled]="currentPage() === (tiendasPage()!.totalPages - 1)">
          <button class="page-link rounded-circle" (click)="goToPage(currentPage() + 1)">
            <i class="bi bi-chevron-right"></i>
          </button>
        </li>
      </ul>
    </nav>
  </ng-container>

  <!-- Modal Crear/Editar -->
  <div class="modal fade" id="storeModal" tabindex="-1"
       [ngClass]="{'show d-block': showCreateModal || showEditModal}">
    <div class="modal-dialog modal-fixed-xl modal-dialog-centered">
      <div class="modal-content border-0 shadow-2xl rounded-4 overflow-hidden bg-white">
        <div class="modal-header bg-gradient-primary text-white border-0 px-5 py-4">
          <div class="d-flex align-items-center gap-3">
            <div class="icon-circle bg-white text-primary shadow d-flex align-items-center justify-content-center">
              <i class="bi bi-shop fs-4"></i>
            </div>
            <h5 class="modal-title fw-bold fs-4 mb-0">
              {{ showEditModal ? 'Editar Tienda' : 'Crear Nueva Tienda' }}
            </h5>
          </div>
          <button type="button" class="btn-close btn-close-white" (click)="closeModal()" [disabled]="loading()"></button>
        </div>

        <div class="modal-body p-0">
          <div class="form-fixed-scroll-container">
            <app-form-stores
              [tienda]="editingStore()"
              (success)="onFormSuccess($event)"
              (cancel)="closeModal()">
            </app-form-stores>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detalles -->
  <div class="modal fade" id="detailsModal" tabindex="-1"
       [ngClass]="{'show d-block': showDetailsModal}">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0 shadow rounded-4">
        <div class="modal-header bg-gradient-info text-white border-0 px-5 py-4">
          <h5 class="modal-title fw-bold fs-4">
            <i class="bi bi-info-circle-fill me-2"></i>
            Detalles de {{ selectedTienda?.nombre }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeDetailsModal()"></button>
        </div>
        <div class="modal-body px-5 py-4" *ngIf="selectedTienda">
          <dl class="row g-3">
            <dt class="col-sm-4 fw-semibold">Nombre</dt>
            <dd class="col-sm-8">{{ selectedTienda.nombre }}</dd>

            <dt class="col-sm-4 fw-semibold">Slug</dt>
            <dd class="col-sm-8">/{{ selectedTienda.slug }}</dd>

            <dt class="col-sm-4 fw-semibold">Plan</dt>
            <dd class="col-sm-8">{{ selectedTienda.planNombre || 'Sin plan' }}</dd>

            <dt class="col-sm-4 fw-semibold">Estado</dt>
            <dd class="col-sm-8">{{ getEstadoSuscripcion(selectedTienda) }}</dd>

            <dt class="col-sm-4 fw-semibold">Vencimiento</dt>
            <dd class="col-sm-8">{{ formatDate(selectedTienda.fechaFin) }}</dd>

            <dt class="col-sm-4 fw-semibold">Productos máx.</dt>
            <dd class="col-sm-8">{{ selectedTienda.maxProductos ?? '—' }}</dd>
          </dl>
        </div>
        <div class="modal-footer border-0 px-5 pb-5">
          <button type="button" class="btn btn-outline-secondary rounded-pill px-5 py-3" (click)="closeDetailsModal()">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrops -->
  <div class="modal-backdrop fade show" *ngIf="showCreateModal || showEditModal"></div>
  <div class="modal-backdrop fade show" *ngIf="showDetailsModal"></div>
</div>