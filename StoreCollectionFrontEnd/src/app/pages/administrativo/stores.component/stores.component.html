<div class="container-fluid py-5">
  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-5 gap-4">
    <div>
      <h1 class="display-5 fw-bold mb-1" style="background: linear-gradient(90deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        <i class="bi bi-shop-window me-3"></i>
        Gestión de Tiendas
      </h1>
      <p class="text-muted fs-5 mb-0">
        {{ auth.isAdmin() ? 'Todas las tiendas de la plataforma' : 'Tus tiendas activas' }}
        <span class="badge bg-primary rounded-pill ms-3 px-3 py-2 fs-6">
          {{ tiendasPage()?.totalElements || 0 }}
        </span>
      </p>
    </div>

    <button class="btn btn-primary btn-lg rounded-pill px-5 shadow-lg" (click)="openCreateModal()">
      <i class="bi bi-plus-circle-fill me-2 fs-4"></i>
      Nueva Tienda
    </button>
  </div>

  <!-- Búsqueda y filtros -->
  <div class="row mb-5 g-3">
    <div class="col-lg-6 col-xl-5">
      <div class="input-group input-group-lg">
        <span class="input-group-text bg-white border-end-0 rounded-start-pill ps-4">
          <i class="bi bi-search text-muted"></i>
        </span>
        <input
          type="text"
          class="form-control border-start-0 rounded-end-pill pe-4"
          placeholder="Buscar por nombre, slug o dueño..."
          [value]="searchInput()"
          (input)="searchInput.set($any($event.target).value)"
        />
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="text-center py-5 my-5">
    <div class="spinner-border text-primary" style="width: 5rem; height: 5rem;" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <h4 class="mt-4 text-primary fw-bold">Cargando tus tiendas...</h4>
    <p class="text-muted">Un momento por favor</p>
  </div>

  <!-- Contenido principal -->
  <ng-container *ngIf="!loading()">
    <!-- Estado vacío -->
    <div *ngIf="tiendas().length === 0" class="text-center py-5 my-5">
      <i class="bi bi-shop-window display-1 text-muted opacity-50 mb-4"></i>
      <h3 class="fw-bold text-dark mb-3">No hay tiendas aún</h3>
      <p class="lead text-muted mb-4" *ngIf="searchTerm().length > 0">
        No encontramos resultados para "<strong>{{ searchTerm() }}</strong>"
      </p>
      <p class="lead text-muted mb-4" *ngIf="searchTerm().length === 0">
        Crea tu primera tienda para empezar a vender
      </p>
      <button class="btn btn-primary btn-lg rounded-pill px-5" (click)="openCreateModal()">
        <i class="bi bi-plus-circle me-2"></i> Crear mi primera tienda
      </button>
    </div>

    <!-- Grid de tiendas -->
    <div *ngIf="tiendas().length > 0" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <div class="col" *ngFor="let tienda of tiendas()">
        <div class="card h-100 border-0 shadow-lg rounded-4 overflow-hidden position-relative store-card-hover">
          <!-- Glow effect -->
          <div class="card-glow"></div>

          <div class="card-body d-flex flex-column p-4 position-relative" style="z-index: 2;">
            <div class="d-flex justify-content-between align-items-start mb-4">
              <div class="d-flex align-items-center gap-3">
                <div class="avatar-circle bg-gradient-primary text-white d-flex align-items-center justify-content-center fw-bold fs-3">
                  {{ tienda.nombre.charAt(0).toUpperCase() }}
                </div>
                <div>
                  <h5 class="card-title fw-bold mb-1">{{ tienda.nombre }}</h5>
                  <small class="text-muted">/{{ tienda.slug }}</small>
                </div>
              </div>

              <span class="badge rounded-pill px-4 py-2 fs-6 fw-semibold"
                    [ngClass]="tienda.activo ? 'bg-success' : 'bg-danger'">
                {{ tienda.activo ? 'Activa' : 'Inactiva' }}
              </span>
            </div>

            <!-- Plan -->
            <div class="mt-2 mb-4">
              <span class="badge rounded-pill px-4 py-2 fs-6 fw-bold text-white"
                    [ngClass]="getPlanBadgeClass(tienda)">
                {{ tienda.planNombre || 'Sin plan' }}
                <small *ngIf="tienda.estadoSuscripcion === 'trial'" class="ms-2">(Trial)</small>
              </span>
            </div>

            <!-- Meta info -->
            <div class="text-muted small mb-4">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-whatsapp me-2 text-success"></i>
                {{ tienda.whatsapp || 'Sin WhatsApp' }}
              </div>
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-currency-exchange me-2 text-primary"></i>
                {{ tienda.moneda }}
              </div>
              <!-- Fecha (si tienes createdAt en el modelo) -->
              <!-- <div class="d-flex align-items-center">
                <i class="bi bi-calendar-event me-2"></i>
                Creada: {{ formatDate(tienda.createdAt) }}
              </div> -->
            </div>

            <!-- Límites -->
            <div class="mt-auto pt-3 border-top">
              <div class="row text-center small fw-semibold">
                <div class="col">
                  <span class="text-primary fs-4">{{ tienda.maxProductos ?? 0 }}</span><br>
                  Productos
                </div>
                <div class="col">
                  <span class="text-primary fs-4">{{ tienda.maxVariantes ?? 0 }}</span><br>
                  Variantes
                </div>
              </div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="card-footer bg-transparent border-0 px-4 pb-4 pt-0">
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary flex-fill rounded-pill py-2" (click)="openEditModal(tienda)">
                <i class="bi bi-pencil-square me-2"></i> Editar
              </button>
              <button class="btn btn-outline-info flex-fill rounded-pill py-2" (click)="verDetalles(tienda)">
                <i class="bi bi-eye me-2"></i> Detalles
              </button>
              <button *ngIf="auth.isAdmin()"
                      class="btn rounded-circle p-3 shadow-sm"
                      [ngClass]="tienda.activo ? 'btn-success' : 'btn-danger'"
                      (click)="toggleActive(tienda)">
                <i class="bi fs-4" [ngClass]="tienda.activo ? 'bi-toggle-on' : 'bi-toggle-off'"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginación -->
    <nav *ngIf="tiendasPage() && tiendasPage()!.totalPages > 1" class="d-flex justify-content-center mt-5">
      <ul class="pagination pagination-lg">
        <li class="page-item" [class.disabled]="currentPage() === 0">
          <button class="page-link rounded-circle me-2" (click)="goToPage(currentPage() - 1)">
            <i class="bi bi-chevron-left"></i>
          </button>
        </li>

        <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage()">
          <button class="page-link rounded-circle mx-1" (click)="goToPage(page)">
            {{ page + 1 }}
          </button>
        </li>

        <li class="page-item" [class.disabled]="currentPage() === (tiendasPage()!.totalPages - 1)">
          <button class="page-link rounded-circle ms-2" (click)="goToPage(currentPage() + 1)">
            <i class="bi bi-chevron-right"></i>
          </button>
        </li>
      </ul>
    </nav>
  </ng-container>

  <!-- Modal Crear/Editar -->
  <div class="modal fade" id="storeModal" tabindex="-1" [class.show]="showCreateModal || showEditModal" [class.d-block]="showCreateModal || showEditModal">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-5 rounded-4 overflow-hidden">
        <div class="modal-header bg-gradient-primary text-white border-0">
          <h5 class="modal-title fw-bold fs-4">
            <i class="bi bi-shop me-2"></i>
            {{ showEditModal ? 'Editar Tienda' : 'Crear Nueva Tienda' }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeModal()" [disabled]="loading()"></button>
        </div>
        <div class="modal-body p-0">
          <app-form-stores
            [tienda]="editingStore()"
            (success)="onFormSuccess($event)"
            (cancel)="closeModal()"
          ></app-form-stores>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop para modal -->
  <div class="modal-backdrop fade show" *ngIf="showCreateModal || showEditModal"></div>

  <!-- Modal Detalles -->
  <div class="modal fade" id="detailsModal" tabindex="-1" [class.show]="showDetailsModal" [class.d-block]="showDetailsModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0 shadow-5 rounded-4">
        <div class="modal-header bg-gradient-info text-white border-0">
          <h5 class="modal-title fw-bold fs-4">
            <i class="bi bi-info-circle-fill me-2"></i>
            Detalles de {{ selectedTienda?.nombre }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeDetailsModal()"></button>
        </div>
        <div class="modal-body" *ngIf="selectedTienda">
          <!-- Aquí pones los detalles como en tu versión anterior -->
          <!-- ... (copia tu contenido de detalles) ... -->
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary rounded-pill px-5" (click)="closeDetailsModal()">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop para modal detalles -->
  <div class="modal-backdrop fade show" *ngIf="showDetailsModal"></div>
</div>