<div class="modal-overlay" (click)="onCancel()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        {{ isEditMode ? 'Editar Tienda' : 'Nueva Tienda' }}
      </h2>
      <button 
        type="button" 
        class="btn-close" 
        aria-label="Cerrar" 
        (click)="onCancel()"
        [disabled]="loading"
      >
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body">
      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="store-form">
        <!-- Logo Section -->
        <div class="logo-section text-center mb-5">
          <div class="logo-preview-container">
            <img 
              *ngIf="logoPreview" 
              [src]="logoPreview" 
              alt="Vista previa del logo" 
              class="logo-preview"
            />
            <div *ngIf="!logoPreview" class="logo-placeholder">
              <i class="bi bi-shop-window"></i>
              <span>Sin logo</span>
            </div>
          </div>

          <div class="mt-3">
            <label for="logoInput" class="btn btn-outline-primary btn-sm px-4">
              <i class="bi bi-cloud-arrow-up me-2"></i>Cambiar logo
            </label>
            <input 
              id="logoInput" 
              type="file" 
              accept="image/jpeg,image/png,image/gif,image/webp" 
              class="d-none" 
              (change)="onFileSelected($event)"
            />
            
            <button 
              *ngIf="logoPreview" 
              type="button" 
              class="btn btn-outline-danger btn-sm ms-2"
              (click)="removeLogo()"
            >
              <i class="bi bi-trash3"></i> Quitar
            </button>
          </div>

          <div class="form-text text-muted mt-2 small">
            JPG, PNG, GIF, WebP • Máx. 5MB • Recomendado 512×512 px
          </div>

          <div class="alert alert-danger mt-2 py-2 small" *ngIf="fileError">
            {{ fileError }}
          </div>
        </div>

        <div class="row g-4">
          <!-- Nombre -->
          <div class="col-12">
            <label class="form-label required">Nombre de la tienda</label>
            <input 
              formControlName="nombre"
              (input)="onNombreChange()"
              type="text" 
              class="form-control" 
              placeholder="Ej: Mi Tienda Online"
              [class.is-invalid]="form.get('nombre')?.invalid && form.get('nombre')?.touched"
            />
            <div class="invalid-feedback">
              {{ getErrorMessage('nombre') }}
            </div>
          </div>

          <!-- Slug -->
          <div class="col-12">
            <label class="form-label required">Slug (URL amigable)</label>
            <div class="input-group input-group-merge">
              <span class="input-group-text bg-light text-muted">storecollection.com/</span>
              <input 
                formControlName="slug"
                type="text" 
                class="form-control" 
                placeholder="mi-tienda"
                [class.is-invalid]="form.get('slug')?.invalid && form.get('slug')?.touched"
                [disabled]="isEditMode"
              />
            </div>
            <div class="invalid-feedback">
              {{ getErrorMessage('slug') }}
            </div>
            <div class="form-text text-muted small" *ngIf="!isEditMode">
              Se generará automáticamente desde el nombre
            </div>
          </div>

          <!-- Propietario (solo ADMIN) -->
          <div class="col-12" *ngIf="esAdmin">
            <label class="form-label required">Propietario</label>
            <select 
              formControlName="userId" 
              class="form-select"
              [class.is-invalid]="form.get('userId')?.invalid && form.get('userId')?.touched"
            >
              <option value="0" disabled>Selecciona un usuario</option>
              <option *ngFor="let u of usuarios" [value]="u.id">
                {{ u.descripcion }}
              </option>
            </select>
            <div class="invalid-feedback">
              {{ getErrorMessage('userId') }}
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">WhatsApp</label>
            <input 
              formControlName="whatsapp"
              type="tel" 
              class="form-control" 
              placeholder="+51 999 999 999"
              [class.is-invalid]="form.get('whatsapp')?.touched && form.get('whatsapp')?.invalid"
            />
            <div class="invalid-feedback">
              {{ getErrorMessage('whatsapp') }}
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label required">Moneda principal</label>
            <select 
              formControlName="moneda" 
              class="form-select"
            >
              <option value="SOLES">Soles (S/)</option>
              <option value="DOLARES">Dólares ($)</option>
            </select>
          </div>

          <!-- Plan -->
          <div class="col-12" *ngIf="esAdmin">
            <label class="form-label required">Plan de la tienda</label>
            <select 
              formControlName="planId" 
              class="form-select"
              [class.is-invalid]="form.get('planId')?.invalid && form.get('planId')?.touched"
              [disabled]="planesLoading"
            >
              <option [value]="null" disabled>
                {{ planesLoading ? 'Cargando planes...' : 'Selecciona un plan' }}
              </option>
              <option *ngFor="let p of planes" [value]="p.id">
                {{ p.descripcion }}
              </option>
            </select>
            <div class="invalid-feedback">
              Debes seleccionar un plan
            </div>
          </div>

          <div class="col-12" *ngIf="!esAdmin">
            <label class="form-label">Plan actual</label>
            <input 
              type="text" 
              class="form-control bg-light" 
              [value]="nombrePlanActual" 
              disabled
            />
          </div>

          <!-- Descripción -->
          <div class="col-12">
            <label class="form-label">Descripción</label>
            <textarea 
              formControlName="descripcion"
              class="form-control" 
              rows="3"
              placeholder="¿Qué ofrece tu tienda? ¿Cuál es tu especialidad?..."
            ></textarea>
          </div>

          <div class="col-md-6">
            <label class="form-label">Dirección física</label>
            <input 
              formControlName="direccion"
              type="text" 
              class="form-control" 
              placeholder="Av. Principal 123, Distrito, Ciudad"
            />
          </div>

          <div class="col-md-6">
            <label class="form-label">Horarios de atención</label>
            <input 
              formControlName="horarios"
              type="text" 
              class="form-control" 
              placeholder="Lun - Sáb 9:00 - 21:00 | Dom 10:00 - 16:00"
            />
          </div>

          <div class="col-12">
            <label class="form-label">Enlace Google Maps</label>
            <input 
              formControlName="mapa_url"
              type="url" 
              class="form-control" 
              placeholder="https://goo.gl/maps/..."
              [class.is-invalid]="form.get('mapa_url')?.touched && form.get('mapa_url')?.invalid"
            />
            <div class="invalid-feedback">
              {{ getErrorMessage('mapa_url') }}
            </div>
          </div>

          <!-- Estado (solo admin) -->
          <div class="col-12" *ngIf="esAdmin">
            <label class="form-label">Estado de la tienda</label>
            <div class="d-flex gap-4 mt-2">
              <div class="form-check">
                <input class="form-check-input" type="radio" formControlName="activo" [value]="true" id="activoSi">
                <label class="form-check-label" for="activoSi">Activa</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" formControlName="activo" [value]="false" id="activoNo">
                <label class="form-check-label" for="activoNo">Inactiva</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensaje de error global -->
        <div class="alert alert-danger mt-4" role="alert" *ngIf="serverError">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ serverError }}
        </div>

        <!-- Acciones -->
        <div class="d-flex gap-3 justify-content-end mt-5 pt-4 border-top">
          <button 
            type="button" 
            class="btn btn-outline-secondary px-4" 
            (click)="onCancel()"
            [disabled]="loading"
          >
            Cancelar
          </button>
          
          <button 
            type="submit" 
            class="btn btn-primary px-5"
            [disabled]="loading || form.invalid || !!fileError"
          >
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
            {{ isEditMode ? 'Guardar Cambios' : 'Crear Tienda' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>