<div class="modal-overlay" (click)="onCancel()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header bg-light border-0 px-4 pt-4 pb-3">
      <h2 class="modal-title fw-bold fs-4 mb-0">
        <i class="bi bi-shop me-2 text-primary"></i>
        {{ isEditMode ? 'Editar Tienda' : 'Crear Nueva Tienda' }}
      </h2>
      <button 
        type="button" 
        class="btn-close" 
        aria-label="Cerrar" 
        (click)="onCancel()"
        [disabled]="loading"
      ></button>
    </div>

    <!-- Body -->
    <div class="modal-body px-4 pb-4">
      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="store-form">
        <!-- Sección Logo -->
        <div class="card border-dashed mb-4">
          <div class="card-body text-center py-4">
            <div class="logo-preview-container mx-auto mb-3">
              <img 
                *ngIf="logoPreview" 
                [src]="logoPreview" 
                alt="Vista previa del logo" 
                class="logo-preview shadow-sm"
              />
              <div *ngIf="!logoPreview" class="logo-placeholder shadow-sm">
                <i class="bi bi-shop-window display-4 text-muted"></i>
                <p class="mt-2 mb-0 text-muted small">Sin logo seleccionado</p>
              </div>
            </div>

            <div class="d-flex justify-content-center gap-2 flex-wrap">
              <label class="btn btn-outline-primary btn-sm px-4" for="logoInput">
                <i class="bi bi-cloud-arrow-up me-2"></i>Subir logo
              </label>
              <input 
                id="logoInput" 
                type="file" 
                accept="image/jpeg,image/png,image/gif,image/webp" 
                class="d-none" 
                (change)="onFileSelected($event)"
              />
              
              <button 
                *ngIf="logoPreview" 
                type="button" 
                class="btn btn-outline-danger btn-sm px-4"
                (click)="removeLogo()"
              >
                <i class="bi bi-trash me-2"></i>Quitar
              </button>
            </div>

            <div class="form-text text-muted mt-3 small">
              Formatos: JPG, PNG, GIF, WebP • Máximo 5MB • Recomendado 512×512 px
            </div>

            <div class="alert alert-danger mt-3 py-2 small" *ngIf="fileError" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>{{ fileError }}
            </div>
          </div>
        </div>

        <!-- Formulario principal -->
        <div class="row g-3">
          <!-- Nombre -->
          <div class="col-12">
            <label class="form-label fw-semibold required">Nombre de la tienda</label>
            <input 
              formControlName="nombre"
              (input)="onNombreChange()"
              type="text" 
              class="form-control"
              placeholder="Ej: Mi Tienda Online"
              [class.is-invalid]="form.get('nombre')?.invalid && form.get('nombre')?.touched"
            />
            <div class="invalid-feedback">
              {{ getErrorMessage('nombre') }}
            </div>
          </div>

          <!-- Slug -->
          <div class="col-12">
            <label class="form-label fw-semibold required">Slug (URL amigable)</label>
            <div class="input-group">
              <span class="input-group-text bg-light">storecollection.com/</span>
              <input 
                formControlName="slug"
                type="text" 
                class="form-control"
                placeholder="mi-tienda"
                [class.is-invalid]="form.get('slug')?.invalid && form.get('slug')?.touched"
                [disabled]="isEditMode"
              />
            </div>
            <div class="invalid-feedback">
              {{ getErrorMessage('slug') }}
            </div>
            <div class="form-text text-muted small" *ngIf="!isEditMode">
              Se genera automáticamente desde el nombre
            </div>
          </div>

          <!-- Correo Remitente -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Correo remitente (From)</label>
            <input 
              formControlName="emailRemitente"
              type="email" 
              class="form-control"
              placeholder="ventas@mitienda.com"
              [class.is-invalid]="form.get('emailRemitente')?.invalid && form.get('emailRemitente')?.touched"
            />
            <div class="invalid-feedback">
              {{ getErrorMessage('emailRemitente') }}
            </div>
            <div class="form-text text-muted small">
              Aparecerá como remitente en los correos enviados por la tienda
            </div>
          </div>

       <!-- Contraseña de Aplicación -->
<div class="col-md-6">
  <label class="form-label fw-semibold">Contraseña de aplicación Gmail</label>
  <div class="input-group">
    <input 
      [type]="showAppPassword ? 'text' : 'password'"
      formControlName="emailAppPassword"
      class="form-control"
      placeholder="16 caracteres alfanuméricos"
      [class.is-invalid]="emailAppPasswordControl.invalid && emailAppPasswordControl.touched"
    />
    <button 
      class="btn btn-outline-secondary" 
      type="button" 
      (click)="toggleAppPasswordVisibility()"
      title="Mostrar/Ocultar contraseña"
    >
      <i class="bi" [ngClass]="showAppPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
    </button>
  </div>
  
  <div class="invalid-feedback">
    {{ getErrorMessage('emailAppPassword') }}
  </div>

  <div class="form-text text-danger small mt-1 fw-semibold" 
       *ngIf="emailAppPasswordControl.value!.length > 0">
    <i class="bi bi-shield-exclamation me-1"></i>
    ¡Campo muy sensible! Nunca compartas esta contraseña.
  </div>

  <div class="form-text text-muted small">
    <a href="https://support.google.com/accounts/answer/185833" target="_blank" class="text-muted">
      ¿Cómo genero una contraseña de aplicación?
    </a>
  </div>
</div>

          <!-- Resto de campos (WhatsApp, Moneda, etc.) -->
          <div class="col-md-6">
            <label class="form-label">WhatsApp</label>
            <input 
              formControlName="whatsapp"
              type="tel" 
              class="form-control"
              placeholder="+51 999 999 999"
              [class.is-invalid]="form.get('whatsapp')?.touched && form.get('whatsapp')?.invalid"
            />
            <div class="invalid-feedback">
              {{ getErrorMessage('whatsapp') }}
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold required">Moneda principal</label>
            <select formControlName="moneda" class="form-select">
              <option value="SOLES">Soles (S/)</option>
              <option value="DOLARES">Dólares ($)</option>
            </select>
          </div>

          <!-- Plan (Admin) -->
          <div class="col-12" *ngIf="esAdmin">
            <label class="form-label fw-semibold required">
              <i class="bi bi-credit-card-2-back me-1 text-primary"></i>
              Plan de suscripción
            </label>
            <select 
              formControlName="planId" 
              class="form-select"
              [class.is-invalid]="form.get('planId')?.invalid && form.get('planId')?.touched"
            >
              <option [ngValue]="null" disabled>
                {{ planesLoading ? 'Cargando planes...' : 'Selecciona un plan' }}
              </option>
              <option *ngFor="let plan of planes" [ngValue]="plan.id">
                {{ plan.descripcion }}
              </option>
            </select>
            <div class="invalid-feedback">
              {{ getErrorMessage('planId') }}
            </div>
          </div>

          <!-- Plan info (no Admin) -->
          <div class="col-12" *ngIf="!esAdmin && isEditMode">
            <div class="alert alert-info small mb-0">
              <strong>Plan actual:</strong> {{ tienda?.planNombre || 'Sin plan asignado' }}
            </div>
          </div>

          <!-- Descripción -->
          <div class="col-12">
            <label class="form-label">Descripción</label>
            <textarea 
              formControlName="descripcion"
              class="form-control" 
              rows="3"
              placeholder="Describe tu tienda, especialidad, valores..."
            ></textarea>
          </div>

          <!-- Dirección y Horarios -->
          <div class="col-md-6">
            <label class="form-label">Dirección física</label>
            <input 
              formControlName="direccion"
              type="text" 
              class="form-control"
              placeholder="Av. Principal 123, Distrito, Ciudad"
            />
          </div>

          <div class="col-md-6">
            <label class="form-label">Horarios de atención</label>
            <input 
              formControlName="horarios"
              type="text" 
              class="form-control"
              placeholder="Lun - Sáb 9:00 - 21:00 | Dom 10:00 - 16:00"
            />
          </div>

          <!-- Mapa -->
          <div class="col-12">
            <label class="form-label">Enlace Google Maps (opcional)</label>
            <input 
              formControlName="mapa_url"
              type="url" 
              class="form-control"
              placeholder="https://goo.gl/maps/..."
              [class.is-invalid]="form.get('mapa_url')?.touched && form.get('mapa_url')?.invalid"
            />
            <div class="invalid-feedback">
              {{ getErrorMessage('mapa_url') }}
            </div>
          </div>

          <!-- Estado (solo admin) -->
          <div class="col-12" *ngIf="esAdmin">
            <label class="form-label fw-semibold">Estado de la tienda</label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" formControlName="activo" [value]="true" id="activoSi">
              <label class="btn btn-outline-success" for="activoSi">Activa</label>

              <input type="radio" class="btn-check" formControlName="activo" [value]="false" id="activoNo">
              <label class="btn btn-outline-danger" for="activoNo">Inactiva</label>
            </div>
          </div>
        </div>

        <!-- Error global -->
        <div class="alert alert-danger mt-4 d-flex align-items-center" role="alert" *ngIf="serverError">
          <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
          <div>{{ serverError }}</div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex gap-3 justify-content-end mt-5 pt-4 border-top">
          <button 
            type="button" 
            class="btn btn-outline-secondary px-5 py-2" 
            (click)="onCancel()"
            [disabled]="loading"
          >
            Cancelar
          </button>
          
          <button 
            type="submit" 
            class="btn btn-primary px-5 py-2"
            [disabled]="loading || form.invalid || !!fileError"
          >
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
            {{ isEditMode ? 'Guardar Cambios' : 'Crear Tienda' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>