<div class="container-fluid py-4 py-md-5">
  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 mb-md-5 gap-3 gap-md-4">
    <div class="mb-3 mb-md-0">
      <h1 class="display-6 display-md-5 fw-bold text-dark mb-1">
        <i class="bi bi-credit-card-2-back-fill text-primary me-2 me-md-3"></i>
        Gestión de Planes
      </h1>
      <p class="text-muted mb-0 fs-5 d-flex align-items-center flex-wrap gap-2">
        Administra los planes de suscripción
        <span class="badge bg-primary rounded-pill px-3 py-1 fs-6">
          {{ pageData()?.totalElements || 0 }} planes
        </span>
      </p>
    </div>

    <button class="btn btn-primary rounded-pill px-4 px-md-5 py-2 py-md-3 shadow w-100 w-md-auto"
            (click)="abrirCrear()">
      <i class="bi bi-plus-circle-fill me-2"></i>
      Nuevo Plan
    </button>
  </div>

  <!-- Búsqueda -->
  <div class="row justify-content-center mb-4 mb-md-5">
    <div class="col-12 col-lg-7 col-xl-6">
      <div class="input-group input-group-lg shadow-sm">
        <span class="input-group-text bg-white border-end-0 rounded-start-pill ps-4">
          <i class="bi bi-search text-primary"></i>
        </span>
        <input
          type="text"
          class="form-control rounded-end-pill pe-4 border-start-0"
          placeholder="Buscar por nombre, slug o descripción..."
          [(ngModel)]="searchTerm"
          (keyup)="onSearch()"
        />
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="text-center py-5 my-5">
    <div class="spinner-border text-primary" style="width: 4.5rem; height: 4.5rem;" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <h4 class="mt-4 fw-bold text-primary">Cargando planes...</h4>
  </div>

  <ng-container *ngIf="!loading()">
    <!-- Estado vacío -->
    <div *ngIf="planes().length === 0" class="text-center py-5 my-5">
      <i class="bi bi-credit-card-2-back display-1 text-muted opacity-50 mb-4"></i>
      <h3 class="fw-bold mb-3">No hay planes aún</h3>
      <p class="lead text-muted mb-4" *ngIf="searchTerm">
        No encontramos resultados para "<strong>{{ searchTerm }}</strong>"
      </p>
      <p class="lead text-muted mb-4" *ngIf="!searchTerm">
        Crea tu primer plan de suscripción
      </p>
      <button class="btn btn-primary rounded-pill px-5 py-3 shadow w-100 w-md-auto" (click)="abrirCrear()">
        <i class="bi bi-plus-circle me-2"></i> Crear primer plan
      </button>
    </div>

    <!-- Lista de planes (tarjetas responsivas) -->
    <div *ngIf="planes().length > 0" class="row row-cols-1 row-cols-md-2 row-cols-lg-1 g-3 g-md-4">
      <div class="col" *ngFor="let p of planes(); trackBy: trackById">
        <div class="card h-100 border-0 shadow-lg rounded-4 overflow-hidden plan-card"
             [class.border-start]="true"
             [ngClass]="{
               'border-primary': p.nombre === 'Pro',
               'border-warning': p.nombre === 'Premium',
               'border-dark': p.nombre === 'Enterprise',
               'border-success': p.nombre === 'Gratis',
               'border-info': p.nombre === 'Básico'
             }">
          <div class="card-body p-3 p-md-4">
            <div class="row align-items-center g-4">
              <!-- Icono + Nombre -->
              <div class="col-12 col-md-5 col-lg-4">
                <div class="d-flex align-items-center gap-3 gap-md-4">
                  <div class="flex-shrink-0">
                    <div class="icon-circle text-white d-flex align-items-center justify-content-center fs-3 fs-md-2"
                         [ngClass]="{
                           'bg-primary': p.nombre === 'Pro' || p.nombre === 'Premium',
                           'bg-warning': p.nombre === 'Enterprise',
                           'bg-success': p.nombre === 'Gratis',
                           'bg-info': p.nombre === 'Básico'
                         }">
                      <i class="bi"
                         [ngClass]="{
                           'bi-gem': p.nombre === 'Premium' || p.nombre === 'Enterprise',
                           'bi-star-fill': p.nombre === 'Pro',
                           'bi-gift-fill': p.nombre === 'Gratis',
                           'bi-box-seam-fill': p.nombre === 'Básico'
                         }"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 min-w-0">
                    <h3 class="fw-bold fs-4 mb-1 text-truncate">{{ p.nombre }}</h3>
                    <small class="text-muted d-block mb-1">{{ p.slug }}</small>
                    <p class="text-muted small mb-0 text-truncate-2">{{ p.descripcion }}</p>
                  </div>
                </div>
              </div>

              <!-- Precio -->
              <div class="col-6 col-md-3 col-lg-2 text-center">
                <div class="fw-bold fs-3 fs-md-4 text-dark">
                  {{ formatPrecio(p.precioMensual) }}
                  <small class="text-muted fs-6">/mes</small>
                </div>
                <ng-container *ngIf="p.precioAnual != null">
                  <div class="text-success small fw-semibold mt-1">
                    {{ formatPrecio(p.precioAnual) }}/año
                    <span class="badge bg-success-subtle text-success ms-2">
                      -{{ calcularAhorro(p) }}%
                    </span>
                  </div>
                </ng-container>
              </div>

              <!-- Límites -->
              <div class="col-6 col-md-2 col-lg-2 text-center">
                <div class="d-flex flex-column gap-2">
                  <div>
                    <div class="fw-bold fs-4">{{ p.maxProductos | number }}</div>
                    <small class="text-muted">prod.</small>
                  </div>
                  <div>
                    <div class="fw-bold fs-4">{{ p.maxVariantes | number }}</div>
                    <small class="text-muted">var.</small>
                  </div>
                </div>
              </div>

              <!-- Trial + Visibilidad + Orden -->
              <div class="col-12 col-lg-2 text-center text-lg-start">
                <div class="d-flex flex-column gap-2">
                  <div>
                    <ng-container *ngIf="p.esTrial; else noTrial">
                      <span class="badge bg-success px-3 py-1 fs-6">
                        {{ p.diasTrial }} días trial
                      </span>
                    </ng-container>
                    <ng-template #noTrial>
                      <small class="text-muted">Sin trial</small>
                    </ng-template>
                  </div>

                  <div>
                    <i class="bi fs-4 me-1"
                       [ngClass]="p.esVisiblePublico ? 'bi-eye-fill text-success' : 'bi-eye-slash text-danger'"></i>
                    <small class="text-muted">{{ p.esVisiblePublico ? 'Público' : 'Oculto' }}</small>
                  </div>

                  <div>
                    <span class="badge bg-secondary px-3 py-1">
                      Orden #{{ p.orden }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Estado + Acciones -->
              <div class="col-12 col-lg-2 text-center text-lg-end mt-3 mt-lg-0">
                <div class="d-flex flex-column gap-3 align-items-center align-items-lg-end">
                  <span class="badge fs-6 px-4 py-2 rounded-pill shadow-sm"
                        [ngClass]="p.activo ? 'bg-success' : 'bg-danger'">
                    {{ p.activo ? 'Activo' : 'Inactivo' }}
                  </span>

                  <div class="d-flex gap-2">
                    <button class="btn rounded-circle shadow p-3"
                            [ngClass]="p.activo ? 'btn-success' : 'btn-outline-danger'"
                            (click)="toggleActivo(p)"
                            title="{{ p.activo ? 'Desactivar' : 'Activar' }}">
                      <i class="bi fs-4"
                         [ngClass]="p.activo ? 'bi-toggle-on' : 'bi-toggle-off'"></i>
                    </button>

                    <button class="btn btn-outline-primary rounded-circle shadow p-3"
                            (click)="abrirEditar(p)"
                            title="Editar">
                      <i class="bi bi-pencil-fill fs-4"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginación -->
    <nav *ngIf="pageData() && pageData()!.totalPages > 1" class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-4 mt-md-5 gap-3">
      <p class="text-muted mb-0">
        Mostrando {{ startItem }}–{{ endItem }} de {{ pageData()?.totalElements }}
      </p>
      <ul class="pagination pagination-md mb-0">
        <li class="page-item" [class.disabled]="currentPage() === 0">
          <button class="page-link" (click)="goToPage(currentPage() - 1)">
            <i class="bi bi-chevron-left"></i>
          </button>
        </li>
        <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage()">
          <button class="page-link" (click)="goToPage(page)">{{ page + 1 }}</button>
        </li>
        <li class="page-item" [class.disabled]="currentPage() === (pageData()!.totalPages - 1)">
          <button class="page-link" (click)="goToPage(currentPage() + 1)">
            <i class="bi bi-chevron-right"></i>
          </button>
        </li>
      </ul>
    </nav>
  </ng-container>

  <!-- Modal -->
  <div class="modal fade" tabindex="-1" [ngClass]="{'show d-block': showModal(), 'd-none': !showModal()}">
    <div class="modal-dialog modal-dialog-centered modal-responsive modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
        <div class="modal-header bg-light border-0 px-4 px-md-5 py-3 py-md-4">
          <h5 class="modal-title fw-bold">Nuevo / Editar Plan</h5>
          <button type="button" class="btn-close" (click)="closeModal()" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body px-4 px-md-5 pb-4 pb-md-5">
          <app-planes-form
            [plan]="editingPlan()"
            (success)="onFormSuccess()"
            (cancel)="closeModal()">
          </app-planes-form>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="showModal()" (click)="closeModal()"></div>
</div>